# 出退勤システム 運用マニュアル・報告書

**作成日**: 2025年11月7日  
**システム名**: 出退勤管理システム（Attendance Management System）  
**バージョン**: 1.0.0

---

## 目次

1. [システム概要](#システム概要)
2. [デプロイ情報](#デプロイ情報)
3. [アクセス情報](#アクセス情報)
4. [ユーザー向けマニュアル](#ユーザー向けマニュアル)
5. [管理者向けマニュアル](#管理者向けマニュアル)
6. [セキュリティ情報](#セキュリティ情報)
7. [トラブルシューティング](#トラブルシューティング)
8. [技術情報](#技術情報)

---

## システム概要

### 目的

従業員の出退勤記録を管理するWebアプリケーションです。出勤・退勤・休憩の記録、管理者による記録の編集、CSVエクスポート、監査ログ機能を提供します。

### 主要機能

- **出退勤管理**: 出勤・退勤・休憩開始・休憩終了の記録
- **ダッシュボード**: 現在の状態と最近の記録を表示
- **管理者機能**: 
  - 全ユーザーの出退勤記録の閲覧・編集
  - ユーザー管理（作成・編集・削除）
  - CSVエクスポート
  - 監査ログ閲覧
- **セキュリティ**: CSRF保護、パスワードハッシュ化、監査ログ

### 技術スタック

- **フレームワーク**: Flask 3.0.3
- **データベース**: PostgreSQL（本番環境）
- **認証**: Flask-Login
- **デプロイ先**: Render

---

## デプロイ情報

### デプロイ先

**プラットフォーム**: Render  
**URL**: （実際のURLを記載してください）  
**デプロイ日**: 2025年11月7日  
**ステータス**: 本番環境稼働中

### 環境変数設定

以下の環境変数が設定されています：

| 変数名 | 値 | 説明 |
|--------|-----|------|
| `SECRET_KEY` | （設定済み） | セッション暗号化用の秘密鍵 |
| `DATABASE_URL` | （設定済み） | PostgreSQL接続URL |
| `TIMEZONE` | `Asia/Tokyo` | 表示用タイムゾーン |
| `SESSION_COOKIE_SECURE` | `true` | HTTPS使用時のセキュリティ設定 |

### データベース

- **種類**: PostgreSQL
- **ホスティング**: Render
- **接続**: Internal Database URL（Render内部ネットワーク経由）

### バックアップ

- RenderのPostgreSQLは自動バックアップ機能あり
- 必要に応じて手動でCSVエクスポート可能

---

## アクセス情報

### アプリケーションURL

**本番環境**: https://（実際のURLを記載してください）

### 初期管理者アカウント

- **ユーザーID**: `admin`
- **パスワード**: （管理者に直接お伝えします）
- **権限**: 管理者（すべての機能にアクセス可能）

### ログイン方法

1. ブラウザでアプリケーションURLにアクセス
2. ユーザーIDとパスワードを入力
3. 「ログイン」ボタンをクリック

---

## ユーザー向けマニュアル

### ダッシュボード

ログイン後、ダッシュボードが表示されます。

#### 表示内容

- **現在の状態**: 出勤中かどうか、休憩中かどうか
- **現在の実働時間**: 出勤中の場合は現在までの実働時間を表示
- **最近の記録**: 過去10件の出退勤記録

### 出勤

1. ダッシュボードの「出勤」ボタンをクリック
2. 出勤時刻が記録されます
3. 画面が更新され、現在の状態が表示されます

**注意**: 既に出勤中の場合は「出勤」ボタンは表示されません。

### 退勤

1. ダッシュボードの「退勤」ボタンをクリック
2. 退勤時刻が記録されます
3. 実働時間が計算されます

**注意**: 出勤中でない場合は「退勤」ボタンは表示されません。

### 休憩開始

1. 出勤中の場合、「休憩開始」ボタンが表示されます
2. 「休憩開始」ボタンをクリック
3. 休憩開始時刻が記録されます

**注意**: 既に休憩中の場合は「休憩開始」ボタンは表示されません。

### 休憩終了

1. 休憩中の場合、「休憩終了」ボタンが表示されます
2. 「休憩終了」ボタンをクリック
3. 休憩終了時刻が記録されます

**注意**: 休憩中でない場合は「休憩終了」ボタンは表示されません。

### ログアウト

1. 右上の「ログアウト」ボタンをクリック
2. ログインページに戻ります

---

## 管理者向けマニュアル

### 管理画面へのアクセス

管理者権限でログインすると、ダッシュボードに「管理画面」へのリンクが表示されます。

### 出退勤記録管理

#### 記録の閲覧

1. 「管理画面」をクリック
2. 期間とユーザーIDでフィルタリング可能
3. 日別集計とシフト一覧が表示されます

#### 記録の編集

1. 管理画面で編集したい記録の「編集」ボタンをクリック
2. モーダルが開き、出勤時刻・退勤時刻を編集できます
3. 「更新」ボタンをクリックして保存

**注意**: すべての編集操作は監査ログに記録されます。

#### CSVエクスポート

1. 管理画面で期間とユーザーを指定
2. 「CSVエクスポート」ボタンをクリック
3. CSVファイルがダウンロードされます

**制限**: 一度にエクスポートできる期間は最大365日です。

### ユーザー管理

#### ユーザーの作成

1. 「ユーザー管理」メニューをクリック
2. 「新規ユーザー作成」フォームに入力
   - ユーザーID（必須）
   - パスワード（必須）
   - 氏名（オプション）
   - メール（オプション）
   - 権限（user/admin）
3. 「作成」ボタンをクリック

#### ユーザーの編集

1. ユーザー一覧で編集したいユーザーの「編集」ボタンをクリック
2. モーダルが開き、情報を編集できます
3. パスワードを変更する場合は、新しいパスワードを入力（空欄の場合は変更なし）
4. 「更新」ボタンをクリック

#### ユーザーの削除

1. ユーザー一覧で削除したいユーザーの「削除」ボタンをクリック
2. 確認ダイアログで「OK」をクリック
3. ユーザーと関連する出退勤記録が削除されます

**注意**: 自分自身は削除できません。

### 監査ログ

1. 「監査ログ」メニューをクリック
2. 操作履歴が表示されます
3. アクションやユーザーでフィルタリング可能
4. CSVエクスポートも可能

---

## セキュリティ情報

### 認証・認可

- **認証方式**: ユーザーIDとパスワード
- **パスワードハッシュ化**: PBKDF2アルゴリズムを使用
- **セッション管理**: Flask-Loginを使用
- **権限管理**: ロールベースアクセス制御（user/admin）

### セキュリティ対策

- **CSRF保護**: すべてのフォーム送信でCSRFトークンを検証
- **セッションCookie**: HttpOnly、SameSite設定
- **HTTPS**: 本番環境ではHTTPSを使用（SESSION_COOKIE_SECURE=true）
- **監査ログ**: すべての操作を記録（IP、User-Agent、HMAC署名付き）

### パスワードポリシー

- **推奨**: 8文字以上、大文字・小文字・数字・記号を含む
- **変更**: 管理者はユーザー管理画面からパスワードをリセット可能

### データ保護

- **データベース**: PostgreSQL（SSL/TLS接続）
- **バックアップ**: Renderの自動バックアップ機能
- **監査ログ**: すべての操作が記録され、改ざん検知可能（HMAC署名）

---

## トラブルシューティング

### ログインできない

**原因と対処法**:

1. **ユーザーIDまたはパスワードが間違っている**
   - 入力内容を確認してください
   - 管理者にパスワードリセットを依頼してください

2. **アカウントが存在しない**
   - 管理者にユーザー作成を依頼してください

### 出勤・退勤ボタンが表示されない

**原因と対処法**:

1. **既に出勤中の場合**
   - 先に退勤してください
   - または、管理者に記録の修正を依頼してください

2. **出勤中でない場合**
   - 先に出勤してください

### CSVエクスポートが失敗する

**原因と対処法**:

1. **期間が長すぎる**
   - 最大365日以内の期間を指定してください

2. **データベース接続エラー**
   - しばらく待ってから再度お試しください
   - 問題が続く場合は管理者に連絡してください

### アプリケーションにアクセスできない

**原因と対処法**:

1. **URLが正しいか確認**
   - 正しいURLにアクセスしているか確認してください

2. **Renderのサービスが停止している**
   - Renderの無料プランは15分間の非アクティブ後にスリープします
   - アクセスすると自動的に起動します（初回アクセス時に数秒かかります）

3. **デプロイエラー**
   - Renderのダッシュボードでログを確認してください

### データが表示されない

**原因と対処法**:

1. **期間指定が正しいか確認**
   - 管理画面で期間を確認してください

2. **ユーザーフィルタが設定されている**
   - ユーザーフィルタをクリアしてください

---

## 技術情報

### システム構成

```
┌─────────────┐
│  ブラウザ    │
└──────┬──────┘
       │ HTTPS
       ▼
┌─────────────────┐
│  Render         │
│  (Web Service)  │
│  Flask + Gunicorn│
└──────┬──────────┘
       │
       ├─── Flask-Login (セッション管理)
       │
       ├─── SQLAlchemy ORM
       │         │
       │         ▼
       │    ┌──────────┐
       │    │PostgreSQL│
       │    │(Render)  │
       │    └──────────┘
       │
       └─── CSV Export
```

### データベース構造

#### 主要テーブル

- **users**: ユーザー情報
- **shifts**: 出退勤記録
- **breaks**: 休憩記録
- **audit_logs**: 監査ログ

### 時刻管理

- **保存**: すべてUTCで保存
- **表示**: 日本時間（Asia/Tokyo）で表示
- **変換**: 自動的にローカル時刻に変換

### APIエンドポイント

主要なエンドポイント：

- `GET /` - ダッシュボード
- `POST /clock/in` - 出勤
- `POST /clock/out` - 退勤
- `POST /break/start` - 休憩開始
- `POST /break/end` - 休憩終了
- `GET /admin` - 管理画面（出退勤記録一覧）
- `GET /admin/users` - ユーザー管理
- `GET /admin/audit` - 監査ログ
- `GET /admin/export` - CSVエクスポート

### 監査ログ

すべての操作が監査ログに記録されます：

- **記録内容**: ユーザーID、操作時刻、IPアドレス、User-Agent、操作内容
- **改ざん検知**: HMAC署名により改ざんを検知可能
- **エクスポート**: CSV形式でエクスポート可能

### パフォーマンス

- **レスポンス時間**: 通常1秒以内
- **同時接続**: Renderのプランに依存
- **データベース**: PostgreSQLのインデックス最適化済み

### バックアップ・復旧

- **自動バックアップ**: RenderのPostgreSQLは自動バックアップ機能あり
- **手動バックアップ**: CSVエクスポート機能で手動バックアップ可能
- **復旧手順**: Renderのダッシュボードからバックアップを復元可能

---

## 連絡先・サポート

### 技術的な問題について

システムに関する技術的な問題や質問がある場合は、開発チームまでご連絡ください。

### 緊急時の対応

システムが利用できない場合：

1. Renderのダッシュボードでサービスの状態を確認
2. ログを確認してエラー内容を特定
3. 必要に応じてサービスを再起動

---

## 付録

### よくある質問（FAQ）

**Q: パスワードを忘れた場合はどうすればいいですか？**  
A: 管理者にパスワードリセットを依頼してください。管理者はユーザー管理画面からパスワードをリセットできます。

**Q: 出退勤記録を修正したい場合はどうすればいいですか？**  
A: 管理者に依頼してください。管理者は管理画面から記録を編集できます。すべての編集操作は監査ログに記録されます。

**Q: CSVエクスポートはどのくらいの期間まで可能ですか？**  
A: 最大365日間です。それ以上の期間が必要な場合は、複数回に分けてエクスポートしてください。

**Q: 無料プランで利用できますか？**  
A: はい、Renderの無料プランで利用可能です。ただし、15分間の非アクティブ後にスリープします。

**Q: データは安全ですか？**  
A: はい、以下のセキュリティ対策を実施しています：
- HTTPS通信
- パスワードハッシュ化
- CSRF保護
- 監査ログ（改ざん検知機能付き）
- PostgreSQLのSSL/TLS接続

---

**文書バージョン**: 1.0  
**最終更新日**: 2025年11月7日

