# 認証・ログイン機能

## 概要

ユーザーIDとパスワードによる認証システムです。Flask-Loginを使用してセッション管理を行います。

## 認証フロー

```
1. ユーザーが /login にアクセス
2. ユーザーIDとパスワードを入力
3. POST /login で認証情報を送信
4. パスワード検証（check_password）
5. 成功 → セッション作成 → /dashboard へリダイレクト
6. 失敗 → エラーメッセージ表示 → /login に戻る
```

## 実装ファイル

### app.py

#### ログイン管理の設定
```python
login_manager = LoginManager(app)
login_manager.login_view = "login"

@login_manager.user_loader
def load_user(user_id):
    return User.query.get(int(user_id))
```

#### ログインエンドポイント
```python
@app.route("/login", methods=["GET", "POST"])
def login():
    # GET: ログインフォーム表示
    # POST: 認証処理
```

**ファイル位置**: `app.py` 266-290行目

#### ログアウトエンドポイント
```python
@app.route("/logout")
@login_required
def logout():
    # ログアウト処理
```

**ファイル位置**: `app.py` 292-297行目

## ユーザーモデル

### Userクラス

**ファイル位置**: `app.py` 54-76行目

```python
class User(db.Model, UserMixin):
    username = db.Column(db.String(100), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(255), nullable=False)
    email = db.Column(db.String(320), unique=True, nullable=True, index=True)
    name = db.Column(db.String(200))
    role = db.Column(db.String(20), default="user")
    created_at = db.Column(db.DateTime(timezone=True))
    last_login_at = db.Column(db.DateTime(timezone=True))
```

### パスワード管理メソッド

```python
def set_password(self, password):
    """パスワードをハッシュ化して設定"""
    self.password_hash = generate_password_hash(password)

def check_password(self, password):
    """パスワードを検証"""
    return check_password_hash(self.password_hash, password)
```

**使用ライブラリ**: `werkzeug.security.generate_password_hash` / `check_password_hash`

## テンプレート

### login.html

**ファイル位置**: `templates/login.html`

**機能**:
- ユーザーID入力フィールド
- パスワード入力フィールド
- CSRFトークン（hidden）
- エラーメッセージ表示（flashメッセージ）

**主要な要素**:
```html
<form method="post">
  <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
  <input type="text" name="username" required>
  <input type="password" name="password" required>
  <button type="submit">ログイン</button>
</form>
```

## セッション管理

### Flask-Loginの設定

- **セッション名**: `session`（Flask標準）
- **Cookie設定**:
  - `SESSION_COOKIE_HTTPONLY`: True（JavaScriptからアクセス不可）
  - `SESSION_COOKIE_SAMESITE`: Lax（CSRF対策）
  - `SESSION_COOKIE_SECURE`: 環境変数で設定（HTTPS時はtrue）

**ファイル位置**: `app.py` 37-39行目

### ログイン状態の確認

**デコレータ**: `@login_required`

```python
@app.route("/dashboard")
@login_required
def dashboard():
    # current_user で現在のユーザーを取得
    user = current_user
```

**テンプレートでの使用**:
```jinja2
{% if current_user.is_authenticated %}
  {{ current_user.username }}
{% endif %}
```

## CSRF保護

### 実装

**ファイル位置**: `app.py` 217-228行目

```python
def ensure_csrf():
    """CSRFトークンをセッションに保存"""
    tok = session.get("csrf_token")
    if not tok:
        tok = secrets.token_urlsafe(32)
        session["csrf_token"] = tok
    return tok

def verify_csrf():
    """CSRFトークンを検証"""
    form_tok = request.form.get("csrf_token", "")
    ok = form_tok and session.get("csrf_token") and secrets.compare_digest(form_tok, session["csrf_token"])
    if not ok:
        abort(400, "CSRF token missing or invalid")
```

### 使用方法

1. **GETリクエスト時**: `ensure_csrf()` を呼び出してトークンを生成
2. **テンプレート**: `{{ session.csrf_token }}` をhiddenフィールドに設定
3. **POSTリクエスト時**: `verify_csrf()` で検証

## 監査ログ

ログイン・ログアウトはすべて監査ログに記録されます。

**ログイン時の記録**:
```python
log_audit("login", target_type="user", target_id=user.id, 
         metadata_dict={"username": username})
```

**ログアウト時の記録**:
```python
log_audit("logout", target_type="user", target_id=current_user.id)
```

**ファイル位置**: `app.py` 283行目、295行目

## セキュリティ考慮事項

1. **パスワードハッシュ化**: PBKDF2アルゴリズム使用（Werkzeug標準）
2. **セッション固定攻撃対策**: Flask-Loginが自動的にセッションIDを変更
3. **CSRF対策**: セッションベースのトークン
4. **ブルートフォース対策**: 現バージョンでは未実装（必要に応じて追加可能）

## 関連機能

- [ユーザー管理機能](05-ユーザー管理機能.md) - ユーザーの作成・編集
- [セキュリティ](11-セキュリティ.md) - セキュリティ対策の詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの仕組み

