# システム概要

## プロジェクト名
出退勤システム（Attendance Management System）

## 目的
Dockerを使えない環境でも、簡単にローカル実行とPaaSデプロイができる出退勤管理システムです。

## 技術スタック

### バックエンド
- **フレームワーク**: Flask 3.0.3
- **認証**: Flask-Login 0.6.3
- **データベース**: SQLAlchemy 2.0.32
  - 開発環境: SQLite
  - 本番環境: PostgreSQL（推奨）
- **パスワードハッシュ化**: Werkzeug (generate_password_hash/check_password_hash)

### フロントエンド
- **テンプレートエンジン**: Jinja2（Flask標準）
- **CSSフレームワーク**: Bootstrap 5
- **JavaScript**: バニラJS（jQuery等の依存なし）

### インフラ
- **WSGIサーバー**: Gunicorn 21.2.0
- **プロキシ対応**: ProxyFix（X-Forwarded-For対応）

## アーキテクチャ

```
┌─────────────┐
│  ブラウザ    │
└──────┬──────┘
       │ HTTP/HTTPS
       ▼
┌─────────────────┐
│  Flask App      │
│  (app.py)       │
└──────┬──────────┘
       │
       ├─── Flask-Login (セッション管理)
       │
       ├─── SQLAlchemy ORM
       │         │
       │         ▼
       │    ┌──────────┐
       │    │Database │
       │    │SQLite/  │
       │    │PostgreSQL│
       │    └──────────┘
       │
       └─── CSV Export Helper
```

## 主要機能

1. **認証・ログイン**: ユーザーID/パスワード認証
2. **出退勤管理**: 出勤・退勤・休憩の記録
3. **ダッシュボード**: 現在の状態と最近の記録を表示
4. **管理者機能**: 
   - 出退勤記録の閲覧・編集
   - ユーザー管理
   - 監査ログ閲覧
5. **CSVエクスポート**: 管理画面からの手動エクスポート
6. **監査ログ**: すべての操作を記録（IP、UA、HMAC署名付き）

## ディレクトリ構成

```
syukin-system/
├── app.py              # メインアプリケーションファイル
├── requirements.txt    # Python依存パッケージ
├── Procfile           # PaaSデプロイ用設定
├── docs/              # ドキュメント（このフォルダ）
├── templates/         # Jinja2テンプレート
│   ├── layout.html
│   ├── login.html
│   ├── dashboard.html
│   ├── admin.html
│   ├── admin_users.html
│   ├── admin_audit.html
│   └── shift_edit.html
├── static/            # 静的ファイル
│   └── style.css
└── scripts/           # セットアップスクリプト
    ├── setup_local.sh
    └── run_local.sh
```

## データフロー

### ログイン処理
```
ユーザー入力 → POST /login → パスワード検証 → セッション作成 → ダッシュボード表示
```

### 出退勤処理
```
ボタンクリック → POST /clock/in → DB保存 → 監査ログ記録 → ダッシュボード更新
```

### 管理者によるデータ編集
```
編集フォーム → POST /admin/shift/<id>/edit → DB更新 → 監査ログ記録（変更前後）
```

## 時刻管理

- **保存**: すべてUTCで保存
- **表示**: `TIMEZONE`環境変数で指定（デフォルト: Asia/Tokyo）
- **変換**: テンプレートフィルタ `fmt_dt` で自動変換

## セキュリティ対策

- CSRF保護（セッションベースのトークン）
- パスワードハッシュ化（Werkzeug PBKDF2）
- セッションCookie設定（HttpOnly, SameSite）
- 監査ログ（すべての操作を記録、HMAC署名付き）
- プロキシ対応（X-Forwarded-For）

## 依存パッケージ

詳細は `requirements.txt` を参照。主要なもの:

- Flask==3.0.3
- Flask-Login==0.6.3
- Flask-SQLAlchemy==3.1.1
- SQLAlchemy==2.0.32
- psycopg2-binary==2.9.9 (PostgreSQL用)
- gunicorn==21.2.0

## 次のステップ

- [認証・ログイン機能](02-認証・ログイン機能.md) - 認証の詳細
- [データベース構造](09-データベース構造.md) - データモデル
- [API・ルーティング](10-API・ルーティング.md) - エンドポイント一覧

