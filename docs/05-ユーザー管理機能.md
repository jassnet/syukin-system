# ユーザー管理機能

## 概要

管理者がユーザーの作成・編集・削除を行う機能です。

## アクセス制御

管理者のみアクセス可能です。

**権限チェック**: `require_admin()` を使用

## ユーザー管理画面

### エンドポイント

**GET /admin/users**（一覧表示）
**POST /admin/users**（作成・更新・削除）

**ファイル位置**: `app.py` 861-944行目

**認証**: ログイン必須 + 管理者権限

### テンプレート

**ファイル位置**: `templates/admin_users.html`

**表示内容**:
- 新規ユーザー作成フォーム
- ユーザー一覧テーブル
- 編集モーダル

## ユーザー作成

### 処理フロー

**アクション**: `action=create`

**ファイル位置**: `app.py` 872-894行目

```
1. CSRFトークン検証
2. フォームデータ取得
   - username（必須）
   - password（必須）
   - name（オプション）
   - email（オプション）
   - role（user/admin）
3. ユーザーIDの重複チェック
4. Userオブジェクト作成
5. パスワードハッシュ化（set_password）
6. DB保存
7. 監査ログ記録
8. フラッシュメッセージ表示
9. ユーザー管理画面へリダイレクト
```

### エラーケース

- **ユーザーID・パスワード未入力**: "ユーザーIDとパスワードは必須です。"
- **ユーザーID重複**: "このユーザーIDは既に使用されています。"

### 作成フォーム

**入力項目**:
- ユーザーID（必須、最大100文字）
- パスワード（必須）
- 氏名（オプション、最大200文字）
- メール（オプション、最大320文字）
- 権限（user/admin）

## ユーザー編集

### 処理フロー

**アクション**: `action=update`

**ファイル位置**: `app.py` 896-916行目

```
1. CSRFトークン検証
2. ユーザーIDからUserオブジェクト取得
3. フォームデータ取得
   - name
   - email
   - role
   - password（変更する場合のみ）
4. フィールド更新
5. パスワードが入力されている場合のみ更新
6. DB保存
7. 監査ログ記録
8. フラッシュメッセージ表示
9. ユーザー管理画面へリダイレクト
```

### 編集フォーム

**モーダル**: Bootstrap Modalを使用

**入力項目**:
- ユーザーID（表示のみ、変更不可）
- パスワード（変更する場合のみ入力、空欄なら変更なし）
- 氏名
- メール
- 権限

**パスワード変更**:
- パスワードフィールドが空欄の場合: 変更しない
- パスワードが入力されている場合: 新しいパスワードで更新

## ユーザー削除

### 処理フロー

**アクション**: `action=delete`

**ファイル位置**: `app.py` 918-932行目

```
1. CSRFトークン検証
2. ユーザーIDからUserオブジェクト取得
3. 自分自身の削除チェック
4. ユーザー名を保存（監査ログ用）
5. DB削除（関連するShift、BreakもCASCADE削除）
6. 監査ログ記録
7. フラッシュメッセージ表示
8. ユーザー管理画面へリダイレクト
```

### 削除制限

**自分自身は削除不可**:
```python
if user.id == current_user.id:
    flash("自分自身を削除することはできません。", "error")
    return redirect(url_for("admin_users"))
```

### 確認ダイアログ

削除ボタンクリック時にJavaScriptで確認:
```javascript
onsubmit="return confirm('本当にこのユーザーを削除しますか？');"
```

## ユーザーモデル

### Userクラス

**ファイル位置**: `app.py` 54-76行目

```python
class User(db.Model, UserMixin):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(255), nullable=False)
    email = db.Column(db.String(320), unique=True, nullable=True, index=True)
    name = db.Column(db.String(200))
    picture = db.Column(db.String(500))  # 将来の拡張用
    role = db.Column(db.String(20), default="user")
    created_at = db.Column(db.DateTime(timezone=True))
    last_login_at = db.Column(db.DateTime(timezone=True))
    shifts = db.relationship("Shift", backref="user", lazy=True)
```

### リレーションシップ

- **User → Shift**: 1対多（1ユーザーは複数のシフトを持つ）
- **削除時**: CASCADE削除（ユーザー削除時、関連するShift、Breakも削除）

## 権限管理

### 権限レベル

- **user**: 一般ユーザー（デフォルト）
  - 自分の出退勤記録のみ閲覧・操作可能
  - 管理画面へのアクセス不可

- **admin**: 管理者
  - すべてのユーザーの出退勤記録を閲覧・編集可能
  - ユーザー管理機能へのアクセス可能
  - 監査ログ閲覧可能
  - システム設定変更可能

### 権限チェック

```python
def is_admin(self):
    return self.role == "admin"
```

**ファイル位置**: `app.py` 75-76行目

**使用例**:
```python
@login_required
def admin_function():
    require_admin()  # 管理者チェック
    # ...
```

## パスワード管理

### パスワードハッシュ化

**使用ライブラリ**: `werkzeug.security`

```python
from werkzeug.security import generate_password_hash, check_password_hash

def set_password(self, password):
    self.password_hash = generate_password_hash(password)

def check_password(self, password):
    return check_password_hash(self.password_hash, password)
```

**ファイル位置**: `app.py` 67-73行目

### ハッシュアルゴリズム

- **アルゴリズム**: PBKDF2（Werkzeug標準）
- **ソルト**: 自動生成
- **イテレーション**: Werkzeugのデフォルト設定

## 監査ログ

すべてのユーザー管理操作は監査ログに記録されます。

### 作成時

```python
log_audit("admin_user_create", target_type="user", target_id=user.id,
         metadata_dict={"username": username, "role": role})
```

### 更新時

```python
log_audit("admin_user_update", target_type="user", target_id=user.id,
         metadata_dict={
             "username": user.username,
             "role": role,
             "password_changed": bool(password)
         })
```

### 削除時

```python
log_audit("admin_user_delete", target_type="user", target_id=user_id,
         metadata_dict={"username": username})
```

## ユーザー一覧表示

### ソート

ユーザーID（username）の昇順で表示

```python
users = User.query.order_by(User.username.asc()).all()
```

### 表示項目

- ユーザーID
- 氏名
- メール
- 権限（バッジ表示）
- 最終ログイン日時
- 作成日時
- 操作ボタン（編集・削除）

## 初期管理者ユーザーの作成

アプリ起動時にはユーザーが存在しないため、初期管理者ユーザーを手動で作成する必要があります。

### 方法1: Pythonコンソールから作成

```python
from app import app, db, User
with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('初期パスワード')
    admin.name = '管理者'
    db.session.add(admin)
    db.session.commit()
```

### 方法2: 既存の管理者から作成

既に管理者が存在する場合、管理画面から新しいユーザーを作成できます。

## 関連機能

- [認証・ログイン機能](02-認証・ログイン機能.md) - ログインの仕組み
- [データベース構造](09-データベース構造.md) - Userモデルの詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの詳細
- [セキュリティ](11-セキュリティ.md) - セキュリティ対策

