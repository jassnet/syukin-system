# デプロイメント

## 概要

出退勤システムのデプロイ手順と環境設定について説明します。

## 前提条件

- Python 3.11以上
- PostgreSQL（本番環境推奨）またはSQLite（開発環境）
- Gunicorn（本番環境）

## ローカル開発環境

### セットアップ手順

```bash
# 1. 仮想環境作成
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# 2. 依存パッケージインストール
pip install -r requirements.txt

# 3. 環境変数設定（オプション）
# .envファイルを作成して設定をカスタマイズ

# 4. アプリ起動
python -m flask --app app run -p 8000
# または
gunicorn -w 3 -b 0.0.0.0:8000 app:app
```

### 初期管理者ユーザー作成

```python
from app import app, db, User
with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('初期パスワード')
    admin.name = '管理者'
    db.session.add(admin)
    db.session.commit()
```

## 本番環境（PaaS）

### 対応PaaS

- Heroku
- Render
- Railway
- Fly.io
- その他（Procfile対応のPaaS）

### デプロイ手順

1. **リポジトリ登録**: GitHub等のリポジトリを登録
2. **Build設定**: `pip install -r requirements.txt`
3. **Start設定**: `gunicorn app:app`
4. **環境変数設定**: 下記を参照
5. **データベース設定**: PostgreSQL接続URLを設定
6. **初期ユーザー作成**: 上記の手順を実行

### 環境変数

#### 必須設定

- **SECRET_KEY**: セッション暗号化用（ランダムな長い文字列）
  ```bash
  SECRET_KEY=$(python -c "import secrets; print(secrets.token_urlsafe(32))")
  ```

- **DATABASE_URL**: PostgreSQL接続URL
  ```
  DATABASE_URL=postgresql://user:password@host:port/dbname
  ```

- **TIMEZONE**: 表示用タイムゾーン
  ```
  TIMEZONE=Asia/Tokyo
  ```

#### 推奨設定

- **SESSION_COOKIE_SECURE**: HTTPS使用時は`true`
  ```
  SESSION_COOKIE_SECURE=true
  ```

#### オプション設定

- **CSV_EXPORT_MAX_DAYS**: 管理画面から手動エクスポートできる最大日数（既定: 365日）

### Procfile

**ファイル位置**: `Procfile`

```
web: gunicorn app:app
```

### Gunicorn設定

**推奨設定**:
```bash
gunicorn -w 4 -b 0.0.0.0:$PORT --timeout 120 app:app
```

**パラメータ説明**:
- `-w 4`: ワーカー数（CPUコア数×2+1を推奨）
- `-b 0.0.0.0:$PORT`: バインドアドレスとポート
- `--timeout 120`: タイムアウト（秒）

## データベース移行

### SQLite → PostgreSQL

1. **データエクスポート**:
   ```bash
   sqlite3 attendance.db .dump > dump.sql
   ```

2. **PostgreSQLインポート**:
   - テーブル構造を確認
   - データをインポート（必要に応じて変換）

3. **接続URL設定**:
   ```
   DATABASE_URL=postgresql://user:password@host:port/dbname
   ```

### スキーマ変更

現バージョンではAlembicなどのマイグレーションツールは使用していません。

**手動マイグレーション手順**:
1. バックアップ取得
2. 新しいカラムを追加（`ALTER TABLE`）
3. データ移行（必要に応じて）
4. アプリ再起動

## セキュリティチェックリスト

- [ ] `SECRET_KEY`が強力なランダム値である
- [ ] `SESSION_COOKIE_SECURE=true`（HTTPS使用時）
- [ ] データベース接続がSSL/TLSで暗号化されている
- [ ] 管理者パスワードが強力である
- [ ] 不要なポートが閉じられている
- [ ] ログファイルが適切に管理されている
- [ ] バックアップが定期的に取得されている

## パフォーマンス最適化

### データベース

- **インデックス**: 必要に応じて追加
- **接続プール**: SQLAlchemyの設定で調整
- **クエリ最適化**: N+1問題の回避

### アプリケーション

- **Gunicornワーカー数**: CPUコア数に応じて調整
- **キャッシュ**: 必要に応じてRedis等を導入
- **静的ファイル**: CDNやNginxで配信

## モニタリング

### ログ

- **アプリケーションログ**: Flask標準ロガー
- **エラーログ**: `app.logger.exception()`で記録
- **監査ログ**: `audit_logs`テーブル

### ヘルスチェック

**エンドポイント**: `GET /healthz`

**レスポンス**: "ok"（テキスト）

PaaSのヘルスチェック機能で使用できます。

## トラブルシューティング

### よくある問題

1. **データベース接続エラー**
   - `DATABASE_URL`が正しいか確認
   - PostgreSQLが起動しているか確認
   - 接続権限を確認

2. **ログインできない**
   - 初期管理者ユーザーが作成されているか確認
   - パスワードが正しいか確認

3. **CSVエクスポートが失敗する**
   - 指定期間が `CSV_EXPORT_MAX_DAYS` を超えていないか確認
   - DB接続が安定しているか確認

4. **パフォーマンスが悪い**
   - データベースインデックスを確認
   - Gunicornワーカー数を調整
   - クエリを最適化

## 関連機能

- [システム概要](01-システム概要.md) - 全体構成
- [セキュリティ](11-セキュリティ.md) - セキュリティ対策

