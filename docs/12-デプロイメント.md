# デプロイメント

## 概要

出退勤システムのデプロイ手順と環境設定について説明します。

## 前提条件

- Python 3.11以上
- PostgreSQL（本番環境推奨）またはSQLite（開発環境）
- Gunicorn（本番環境）

## ローカル開発環境

### セットアップ手順

```bash
# 1. 仮想環境作成
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

# 2. 依存パッケージインストール
pip install -r requirements.txt

# 3. 環境変数設定（オプション）
# .envファイルを作成して設定をカスタマイズ

# 4. DB初期化（初回のみ）
flask --app app init-db

# 5. アプリ起動
python -m flask --app app run -p 8000
# または
gunicorn -w 3 -b 0.0.0.0:8000 app:app
```

### 初期管理者ユーザー作成

```python
from app import app, db, User
with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('初期パスワード')
    admin.name = '管理者'
    db.session.add(admin)
    db.session.commit()
```

## 本番環境（Render推奨）

### デプロイ状況

**本番環境**: Renderにデプロイ済み（2025-11-07）

### 推奨PaaS: Render

本システムは **Render** を推奨します。以下の理由があります：

- **無料プランあり**: 小規模運用に最適
- **PostgreSQL対応**: データベースが簡単に作成できる
- **自動デプロイ**: GitHub連携で自動デプロイ可能
- **シンプルな設定**: 直感的なダッシュボード

### その他の対応PaaS

以下のPaaSプラットフォームでもデプロイ可能です：

- **Railway** - シンプルなデプロイ、PostgreSQL対応
- **Heroku** - 最も一般的なPaaS（有料プラン必要）
- **Fly.io** - グローバル分散、PostgreSQL対応
- **その他** - Procfile対応のPaaSであれば動作可能

### デプロイ前の準備

#### 1. GitHubリポジトリへのプッシュ

```bash
# コードをGitHubにプッシュ（まだの場合）
git add .
git commit -m "Initial commit"
git remote add origin https://github.com/your-username/syukin-system.git
git push -u origin main
```

#### 2. SECRET_KEYの生成

```bash
# Pythonで生成
python -c "import secrets; print(secrets.token_urlsafe(32))"

# またはPowerShellで生成（Windows）
python -c "import secrets; print(secrets.token_urlsafe(32))"
```

生成された値をコピーして保存してください（後で環境変数として設定します）。

### Renderでのデプロイ手順（推奨）

#### ステップ1: Renderアカウント作成

1. https://dashboard.render.com にアクセス
2. GitHubアカウントでサインアップ（推奨）

#### ステップ2: PostgreSQLデータベースの作成

**重要**: 本番環境では必ずPostgreSQLを使用してください。

1. Renderダッシュボードで「**New**」→「**Postgres**」をクリック
2. 設定を入力：
   - **Name**: `syukin-db`（任意）
   - **Database**: `syukin_db`（任意）
   - **Region**: `Singapore`（日本に近い）
   - **PostgreSQL Version**: 最新
   - **Plan**: Free（無料プラン）または有料プラン
3. 「**Create Database**」をクリック
4. 作成後、**Internal Database URL**をコピー（後で使用）

#### ステップ3: Web Serviceの作成

1. Renderダッシュボードで「**New**」→「**Web Service**」をクリック
2. GitHubリポジトリを選択（未連携の場合は「Connect account」でGitHubを連携）
3. リポジトリを選択して「**Connect**」

#### ステップ4: Web Serviceの設定

以下の設定を入力：

**基本設定**:
- **Name**: `syukin-system`（任意）
- **Region**: `Singapore`
- **Branch**: `main`
- **Root Directory**: （空欄のまま）

**Build & Deploy**:
- **Build Command**: `pip install -r requirements.txt`
- **Start Command**: `gunicorn app:app`

**Environment Variables**:
「**Add Environment Variable**」をクリックして以下を追加：

| Key | Value |
|-----|-------|
| `SECRET_KEY` | （ステップ2で生成した値） |
| `DATABASE_URL` | （ステップ2でコピーしたInternal Database URL） |
| `TIMEZONE` | `Asia/Tokyo` |
| `SESSION_COOKIE_SECURE` | `true` |

**Advanced**:
- **Auto-Deploy**: `Yes`（GitHubにプッシュで自動デプロイ）

4. 「**Create Web Service**」をクリック

#### ステップ5: デプロイ完了を待つ

- ビルドとデプロイが自動開始されます
- ログで進行状況を確認できます
- 完了まで数分かかります

#### ステップ6: データベースの初期化

デプロイ完了後：

1. Web Serviceのダッシュボードで「**Shell**」タブを開く
2. シェルで以下を実行：
```bash
flask --app app init-db
```

#### ステップ7: 初期管理者ユーザーの作成

同じシェルで：

```bash
python
```

Pythonコンソールが開いたら、以下を実行：

```python
from app import app, db, User
with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('強力なパスワードを設定してください')
    admin.name = '管理者'
    admin.email = 'admin@example.com'  # オプション
    db.session.add(admin)
    db.session.commit()
    print("管理者ユーザーを作成しました")
```

`exit()`でPythonコンソールを終了します。

#### ステップ8: 動作確認

1. Web Serviceのダッシュボードで「**URL**」を確認（例: `https://syukin-system.onrender.com`）
2. ブラウザでアクセス
3. ログインページが表示されることを確認
4. 作成した管理者ユーザーでログイン

### その他PaaSでのデプロイ手順

#### Railway

1. **ダッシュボード**: https://railway.app
2. **New Project** → **Deploy from GitHub repo**
3. **リポジトリを選択**
4. **New** → **Database** → **Add PostgreSQL**
5. **Variables**タブで環境変数を設定
6. デプロイが自動開始されます
7. デプロイ完了後、**View Logs** → **Open Shell**からDB初期化と管理者作成を実行

#### Heroku

1. **Heroku CLIのインストール**: https://devcenter.heroku.com/articles/heroku-cli
2. **ログイン**: `heroku login`
3. **アプリ作成**: `heroku create your-app-name`
4. **PostgreSQL追加**: `heroku addons:create heroku-postgresql:mini`
5. **環境変数設定**:
   ```bash
   heroku config:set SECRET_KEY="your-secret-key"
   heroku config:set TIMEZONE="Asia/Tokyo"
   heroku config:set SESSION_COOKIE_SECURE="true"
   ```
6. **デプロイ**: `git push heroku main`
7. **DB初期化**: `heroku run flask --app app init-db`
8. **管理者作成**: `heroku run python` でPythonコンソールを起動し、管理者ユーザー作成コードを実行

#### Fly.io

1. **Fly CLIのインストール**: https://fly.io/docs/getting-started/installing-flyctl/
2. **ログイン**: `fly auth login`
3. **アプリ作成**: `fly launch`
4. **PostgreSQL作成**: `fly postgres create`
5. **PostgreSQL接続**: `fly postgres attach -a your-app-name`
6. **環境変数設定**: `fly secrets set SECRET_KEY="your-secret-key" TIMEZONE="Asia/Tokyo" SESSION_COOKIE_SECURE="true"`
7. **デプロイ**: `fly deploy`
8. **DB初期化**: `fly ssh console` → `flask --app app init-db`
9. **管理者作成**: `fly ssh console` → `python` で管理者ユーザー作成コードを実行

### 環境変数の詳細

上記のステップ5で設定する環境変数の詳細です。

#### 必須環境変数

**SECRET_KEY**
- **説明**: セッション暗号化、CSRFトークン生成、HMAC署名に使用
- **生成方法**: `python -c "import secrets; print(secrets.token_urlsafe(32))"`
- **要件**: 32文字以上のランダムな文字列
- **注意**: 本番環境では必ず設定してください。設定しないと起動のたびに新しい値が生成され、セッションが無効になります

**DATABASE_URL**
- **説明**: PostgreSQLデータベースへの接続URL
- **形式**: `postgresql://ユーザー名:パスワード@ホスト名:ポート/データベース名`
- **取得方法**: 各PaaSでPostgreSQLを作成すると自動生成されます
- **注意**: 本番環境では必ずPostgreSQLを使用してください。SQLiteは開発環境専用です

**TIMEZONE**
- **説明**: 表示用のタイムゾーン
- **値**: `Asia/Tokyo`（日本時間の場合）
- **注意**: データベース内の時刻はUTCで保存されますが、表示時にこのタイムゾーンで変換されます

#### 推奨環境変数

**SESSION_COOKIE_SECURE**
- **説明**: HTTPS使用時にセッションCookieを保護
- **値**: `true`（HTTPS使用時）、`false`または未設定（HTTP使用時）
- **注意**: 本番環境でHTTPSを使用する場合は必ず`true`に設定してください

#### オプション環境変数

**CSV_EXPORT_MAX_DAYS**
- **説明**: 管理画面から手動でCSVエクスポートできる最大日数
- **既定値**: `365`（1年）
- **例**: `CSV_EXPORT_MAX_DAYS=730`（2年間）

### Procfile

**ファイル位置**: `Procfile`

```
web: gunicorn app:app
```

### Gunicorn設定

**推奨設定**:
```bash
gunicorn -w 4 -b 0.0.0.0:$PORT --timeout 120 app:app
```

**パラメータ説明**:
- `-w 4`: ワーカー数（CPUコア数×2+1を推奨）
- `-b 0.0.0.0:$PORT`: バインドアドレスとポート
- `--timeout 120`: タイムアウト（秒）

## データベース移行

### SQLite → PostgreSQL

1. **データエクスポート**:
   ```bash
   sqlite3 attendance.db .dump > dump.sql
   ```

2. **PostgreSQLインポート**:
   - テーブル構造を確認
   - データをインポート（必要に応じて変換）

3. **接続URL設定**:
   ```
   DATABASE_URL=postgresql://user:password@host:port/dbname
   ```

### スキーマ変更

現バージョンではAlembicなどのマイグレーションツールは使用していません。

**手動マイグレーション手順**:
1. バックアップ取得
2. 新しいカラムを追加（`ALTER TABLE`）
3. データ移行（必要に応じて）
4. アプリ再起動

## デプロイ後のチェックリスト

### 必須チェック項目

- [ ] **データベースが初期化されている**
  - `flask --app app init-db` を実行済み
  - テーブル（users, shifts, breaks, audit_logs）が作成されている

- [ ] **初期管理者ユーザーが作成されている**
  - 管理者ユーザーでログインできることを確認
  - パスワードは強力なものを設定済み

- [ ] **環境変数が正しく設定されている**
  - `SECRET_KEY`が設定されている
  - `DATABASE_URL`が設定されている（PostgreSQL）
  - `TIMEZONE`が設定されている
  - `SESSION_COOKIE_SECURE=true`（HTTPS使用時）

- [ ] **アプリケーションが正常に起動している**
  - `/healthz`エンドポイントが`ok`を返す
  - ログイン画面が表示される
  - エラーログに重大なエラーがない

### セキュリティチェック項目

- [ ] `SECRET_KEY`が強力なランダム値である（32文字以上）
- [ ] `SESSION_COOKIE_SECURE=true`（HTTPS使用時）
- [ ] データベース接続がSSL/TLSで暗号化されている
- [ ] 管理者パスワードが強力である（8文字以上、大文字・小文字・数字・記号を含む）
- [ ] 不要なポートが閉じられている
- [ ] ログファイルが適切に管理されている
- [ ] バックアップが定期的に取得されている

### 動作確認項目

- [ ] **ログイン機能**
  - 管理者ユーザーでログインできる
  - ログアウトできる

- [ ] **出退勤機能**
  - 出勤を記録できる
  - 退勤を記録できる
  - 休憩開始・終了を記録できる

- [ ] **管理機能**
  - 出退勤記録の一覧が表示される
  - 出退勤記録の編集ができる
  - CSVエクスポートができる
  - ユーザー管理ができる

- [ ] **監査ログ**
  - 操作が監査ログに記録されている
  - 監査ログのエクスポートができる

## パフォーマンス最適化

### データベース

- **インデックス**: 必要に応じて追加
- **接続プール**: SQLAlchemyの設定で調整
- **クエリ最適化**: N+1問題の回避

### アプリケーション

- **Gunicornワーカー数**: CPUコア数に応じて調整
- **キャッシュ**: 必要に応じてRedis等を導入
- **静的ファイル**: CDNやNginxで配信

## モニタリング

### ログ

- **アプリケーションログ**: Flask標準ロガー
- **エラーログ**: `app.logger.exception()`で記録
- **監査ログ**: `audit_logs`テーブル

### ヘルスチェック

**エンドポイント**: `GET /healthz`

**レスポンス**: "ok"（テキスト）

PaaSのヘルスチェック機能で使用できます。

## トラブルシューティング

### よくある問題

1. **データベース接続エラー**
   - `DATABASE_URL`が正しいか確認
   - PostgreSQLが起動しているか確認
   - 接続権限を確認

2. **ログインできない**
   - 初期管理者ユーザーが作成されているか確認
   - パスワードが正しいか確認

3. **CSVエクスポートが失敗する**
   - 指定期間が `CSV_EXPORT_MAX_DAYS` を超えていないか確認
   - DB接続が安定しているか確認

4. **パフォーマンスが悪い**
   - データベースインデックスを確認
   - Gunicornワーカー数を調整
   - クエリを最適化

## クイックリファレンス（Render）

### Renderでの本番環境デプロイの最小手順

1. **Renderアカウント作成**: https://dashboard.render.com
2. **PostgreSQL作成**: 「New」→「Postgres」→ Internal Database URLをコピー
3. **SECRET_KEY生成**: `python -c "import secrets; print(secrets.token_urlsafe(32))"`
4. **Web Service作成**: 「New」→「Web Service」→ GitHubリポジトリを連携
5. **環境変数設定**:
   - `SECRET_KEY`（生成した値）
   - `DATABASE_URL`（PostgreSQLのInternal Database URL）
   - `TIMEZONE=Asia/Tokyo`
   - `SESSION_COOKIE_SECURE=true`
6. **デプロイ実行**（自動デプロイまたは手動デプロイ）
7. **DB初期化**: Shellタブから `flask --app app init-db`
8. **管理者作成**: Shellタブから `python` → 管理者ユーザー作成コードを実行
9. **動作確認**: アプリURLにアクセスしてログイン

### 重要な環境変数

| 変数名 | 必須 | 説明 | 例 |
|--------|------|------|-----|
| `SECRET_KEY` | ✅ | セッション暗号化用 | `abc123...xyz`（32文字以上） |
| `DATABASE_URL` | ✅ | PostgreSQL接続URL | `postgresql://user:pass@host:5432/db` |
| `TIMEZONE` | ✅ | 表示用タイムゾーン | `Asia/Tokyo` |
| `SESSION_COOKIE_SECURE` | ⚠️ | HTTPS使用時は必須 | `true` |
| `CSV_EXPORT_MAX_DAYS` | ❌ | CSVエクスポート最大日数 | `365`（既定値） |

### DATABASE_URLの形式（Render）

Renderでは、PostgreSQLデータベースを作成すると**Internal Database URL**と**External Database URL**の2つが提供されます。

**Web Serviceから接続する場合**: **Internal Database URL**を使用してください。

```
postgresql://ユーザー名:パスワード@ホスト名:ポート/データベース名
```

例（RenderのInternal Database URL）:
```
postgresql://syukin_db_user:password123@dpg-xxxxx-a.singapore-postgres.render.com:5432/syukin_db
```

### 管理者ユーザー作成コード

```python
from app import app, db, User
with app.app_context():
    admin = User(username='admin', role='admin')
    admin.set_password('強力なパスワードを設定')
    admin.name = '管理者'
    admin.email = 'admin@example.com'  # オプション
    db.session.add(admin)
    db.session.commit()
    print("管理者ユーザーを作成しました")
```

## 関連機能

- [システム概要](01-システム概要.md) - 全体構成
- [セキュリティ](11-セキュリティ.md) - セキュリティ対策

