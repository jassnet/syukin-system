# 監査ログ機能

## 概要

システム内のすべての操作を記録し、監査要件を満たすための機能です。

## 監査ログモデル

### AuditLogクラス

**ファイル位置**: `app.py` 124-136行目

```python
class AuditLog(db.Model):
    __tablename__ = "audit_logs"
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=True, index=True)
    user = db.relationship("User", backref="audit_logs")
    action = db.Column(db.String(50), nullable=False)
    target_type = db.Column(db.String(50))
    target_id = db.Column(db.Integer)
    ip = db.Column(db.String(100))
    user_agent = db.Column(db.String(300))
    metadata_json = db.Column(db.Text)
    created_at = db.Column(db.DateTime(timezone=True))
    signature = db.Column(db.String(128))  # HMAC署名
```

### フィールド説明

- **user_id**: 操作を行ったユーザーID（未ログイン時はNULL）
- **action**: 操作の種類（例: "login", "clock_in", "admin_user_create"）
- **target_type**: 操作対象のタイプ（例: "user", "shift", "system"）
- **target_id**: 操作対象のID
- **ip**: クライアントIPアドレス
- **user_agent**: ブラウザのUser-Agent
- **metadata_json**: 追加情報（JSON形式）
- **created_at**: 記録日時（UTC）
- **signature**: HMAC署名（改ざん検知用）

## ログ記録関数

### log_audit関数

**ファイル位置**: `app.py` 198-215行目

```python
def log_audit(action, target_type=None, target_id=None, metadata_dict=None):
    try:
        md = json.dumps(metadata_dict or {}, ensure_ascii=False, separators=(",", ":"))
        sig = sign_payload(f"{action}|{target_type}|{target_id}|{md}")
        entry = AuditLog(
            user_id=(current_user.get_id() if current_user.is_authenticated else None),
            action=action,
            target_type=target_type,
            target_id=target_id,
            ip=client_ip(),
            user_agent=user_agent(),
            metadata_json=md,
            signature=sig,
        )
        db.session.add(entry)
        db.session.commit()
    except Exception as e:
        app.logger.exception("Audit log failed: %s", e)
```

### 使用例

```python
# ログイン
log_audit("login", target_type="user", target_id=user.id, 
         metadata_dict={"username": username})

# 出勤
log_audit("clock_in", target_type="shift", target_id=shift.id,
         metadata_dict={"at": shift.clock_in_at.isoformat()})

# ユーザー作成
log_audit("admin_user_create", target_type="user", target_id=user.id,
         metadata_dict={"username": username, "role": role})

# データ編集（変更前後の値を記録）
log_audit("admin_shift_edit", target_type="shift", target_id=shift_id,
         metadata_dict={
             "user_username": shift.user.username,
             "old_values": {"clock_in_at": "...", "clock_out_at": "..."},
             "new_values": {"clock_in_at": "...", "clock_out_at": "..."}
         })
```

## HMAC署名

### 署名生成

**ファイル位置**: `app.py` 187-189行目

```python
def sign_payload(payload: str) -> str:
    key = (app.config["SECRET_KEY"]).encode("utf-8")
    return hmac.new(key, payload.encode("utf-8"), hashlib.sha256).hexdigest()
```

### 署名の役割

- **改ざん検知**: ログエントリが改ざんされていないか検証可能
- **整合性確認**: 署名を再計算して比較することで検証

### 署名対象データ

```
{action}|{target_type}|{target_id}|{metadata_json}
```

例: `login|user|1|{"username":"admin"}`

## 監査ログ閲覧

### エンドポイント

**GET /admin/audit**

**ファイル位置**: `app.py` 686-716行目

**認証**: ログイン必須 + 管理者権限

### フィルタ機能

1. **アクション（action）フィルタ**
   - 特定の操作のみ表示
   - 例: "login", "admin_user_create", "admin_shift_edit"

2. **ユーザーID（username）フィルタ**
   - 特定ユーザーの操作のみ表示
   - オートコンプリート対応

3. **件数制限**
   - デフォルト: 200件
   - 最大: 500件

### 表示内容

- 日時（ローカル時刻）
- ユーザー（名前・ユーザーID・メール）
- アクション（バッジ表示）
- 対象（タイプ・ID）
- IPアドレス・User-Agent
- 詳細（JSON展開可能）

### テンプレート

**ファイル位置**: `templates/admin_audit.html`

## CSVエクスポート

### エンドポイント

**GET /admin/audit/export**

**ファイル位置**: `app.py` 718-789行目

**クエリパラメータ**:
- `action`: アクションフィルタ（オプション）
- `username`: ユーザーIDフィルタ（オプション）
- `limit`: 最大件数（デフォルト: 1000、最大: 5000）

### CSV形式

**ヘッダー**:
```
created_at_local,created_at_utc,action,user_username,user_email,user_name,target_type,target_id,ip,user_agent,metadata_json,signature
```

**ファイル名**: `audit_export_YYYYMMDD_HHMMSS.csv`

**文字コード**: UTF-8 with BOM (`utf-8-sig`)

## 記録される操作

### 認証関連

- **login**: ログイン
- **logout**: ログアウト

### 出退勤関連

- **clock_in**: 出勤
- **clock_out**: 退勤
- **break_start**: 休憩開始
- **break_end**: 休憩終了

### 管理者操作

- **admin_user_create**: ユーザー作成
- **admin_user_update**: ユーザー更新
- **admin_user_delete**: ユーザー削除
- **admin_shift_edit**: 出退勤データ編集
- **admin_export**: CSVエクスポート
- **admin_audit_export**: 監査ログエクスポート

## メタデータの例

### ログイン

```json
{
  "username": "user001"
}
```

### 出勤

```json
{
  "at": "2024-01-01T09:00:00+00:00"
}
```

### ユーザー作成

```json
{
  "username": "newuser",
  "role": "user"
}
```

### データ編集

```json
{
  "user_username": "user001",
  "user_email": "user@example.com",
  "old_values": {
    "clock_in_at": "2024-01-01T00:00:00+00:00",
    "clock_out_at": "2024-01-01T09:00:00+00:00"
  },
  "new_values": {
    "clock_in_at": "2024-01-01T00:15:00+00:00",
    "clock_out_at": "2024-01-01T09:00:00+00:00"
  }
}
```

## セキュリティ考慮事項

### 改ざん防止

- **HMAC署名**: すべてのログエントリに署名を付与
- **検証方法**: 署名を再計算して比較

### プライバシー保護

- **IPアドレス**: 記録されるが、必要に応じてマスキング可能
- **User-Agent**: 記録されるが、必要に応じて削除可能

### ログの保存期間

現バージョンでは自動削除機能はありません。必要に応じて定期メンテナンスで古いログを削除してください。

## パフォーマンス

### インデックス

- `user_id`: インデックスあり
- `created_at`: 降順でソート（インデックス推奨）

### 大量データへの対応

- フィルタ機能で絞り込み
- 件数制限で表示件数を制御
- CSVエクスポートで一括取得

## 関連機能

- [セキュリティ](11-セキュリティ.md) - セキュリティ対策の詳細
- [データベース構造](09-データベース構造.md) - AuditLogモデルの詳細
- [管理者機能（出退勤記録管理）](04-管理者機能（出退勤記録管理）.md) - データ編集の監査

