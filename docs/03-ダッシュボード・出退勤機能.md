# ダッシュボード・出退勤機能

## 概要

ユーザーが自分の出退勤を記録し、現在の状態を確認できる機能です。

## ダッシュボード

### エンドポイント

**GET /** または **GET /dashboard**

**ファイル位置**: `app.py` 299-308行目

**認証**: ログイン必須（`@login_required`）

### 表示内容

1. **現在の出退勤状態**
   - 出勤中の場合: 出勤時刻、現在の実働時間
   - 休憩中の場合: 休憩開始時刻

2. **操作ボタン**
   - 出勤（出勤中でない場合）
   - 退勤（出勤中の場合）
   - 休憩開始（出勤中かつ休憩中でない場合）
   - 休憩終了（休憩中の場合）

3. **最近の記録**
   - 過去10件の出退勤記録
   - 出勤時刻、退勤時刻、実働時間

### テンプレート

**ファイル位置**: `templates/dashboard.html`

**主要な変数**:
- `open_shift`: 現在出勤中のShiftオブジェクト（Noneの場合は出勤中でない）
- `open_break`: 現在休憩中のBreakオブジェクト（Noneの場合は休憩中でない）
- `recent`: 最近10件のShiftリスト

## 出退勤操作

### 出勤（Clock In）

**エンドポイント**: **POST /clock/in**

**ファイル位置**: `app.py` 311-323行目

**処理フロー**:
```
1. CSRFトークン検証
2. 既に出勤中でないか確認
3. 現在時刻をUTCで取得
4. Shiftレコード作成
   - clock_in_at: 現在時刻
   - clock_in_ip: クライアントIP
   - clock_in_ua: User-Agent
5. 監査ログ記録
6. フラッシュメッセージ表示
7. ダッシュボードへリダイレクト
```

**エラーケース**:
- 既に出勤中: "すでに出勤中です。先に退勤してください。"

### 退勤（Clock Out）

**エンドポイント**: **POST /clock/out**

**ファイル位置**: `app.py` 325-338行目

**処理フロー**:
```
1. CSRFトークン検証
2. 出勤中のShiftを取得（なければエラー）
3. 休憩中の場合、休憩を終了
4. clock_out_atを現在時刻に設定
5. clock_out_ip, clock_out_uaを記録
6. 監査ログ記録
7. フラッシュメッセージ表示
8. ダッシュボードへリダイレクト
```

**エラーケース**:
- 出勤中でない: "現在、出勤中の記録はありません。"

### 休憩開始（Break Start）

**エンドポイント**: **POST /break/start**

**ファイル位置**: `app.py` 340-353行目

**処理フロー**:
```
1. CSRFトークン検証
2. 出勤中のShiftを取得
3. 既に休憩中でないか確認
4. Breakレコード作成
   - start_at: 現在時刻
   - start_ip, start_ua: 記録
5. 監査ログ記録
6. ダッシュボードへリダイレクト
```

**エラーケース**:
- 出勤中でない: "現在、出勤中の記録はありません。"
- 既に休憩中: "既に休憩中です。先に休憩終了をしてください。"

### 休憩終了（Break End）

**エンドポイント**: **POST /break/end**

**ファイル位置**: `app.py` 355-368行目

**処理フロー**:
```
1. CSRFトークン検証
2. 出勤中のShiftを取得
3. 休憩中のBreakを取得
4. end_atを現在時刻に設定
5. end_ip, end_uaを記録
6. 監査ログ記録
7. ダッシュボードへリダイレクト
```

**エラーケース**:
- 出勤中でない: "現在、出勤中の記録はありません。"
- 休憩中でない: "現在、休憩中の記録はありません。"

## データモデル

### Shift（シフト）モデル

**ファイル位置**: `app.py` 78-111行目

```python
class Shift(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False)
    clock_in_at = db.Column(db.DateTime(timezone=True), nullable=False)
    clock_out_at = db.Column(db.DateTime(timezone=True), nullable=True)
    clock_in_ip = db.Column(db.String(100))
    clock_in_ua = db.Column(db.String(300))
    clock_out_ip = db.Column(db.String(100))
    clock_out_ua = db.Column(db.String(300))
    created_at = db.Column(db.DateTime(timezone=True))
    breaks = db.relationship("Break", backref="shift", lazy=True)
```

**プロパティ**:
- `is_open`: 出勤中かどうか（clock_out_atがNone）
- `total_break_seconds()`: 休憩時間の合計（秒）
- `worked_seconds()`: 実働時間（秒） = 出勤から退勤までの時間 - 休憩時間

### Break（休憩）モデル

**ファイル位置**: `app.py` 113-122行目

```python
class Break(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    shift_id = db.Column(db.Integer, db.ForeignKey("shifts.id"), nullable=False)
    start_at = db.Column(db.DateTime(timezone=True), nullable=False)
    end_at = db.Column(db.DateTime(timezone=True), nullable=True)
    start_ip = db.Column(db.String(100))
    start_ua = db.Column(db.String(300))
    end_ip = db.Column(db.String(100))
    end_ua = db.Column(db.String(300))
```

## 時刻管理

### UTC保存

すべての時刻はUTCで保存されます。

```python
now = datetime.now(timezone.utc)
```

### 表示時の変換

テンプレートフィルタ `fmt_dt` で自動的にローカル時刻に変換されます。

**ファイル位置**: `app.py` 234-242行目

```python
@app.template_filter("fmt_dt")
def fmt_dt(dt):
    if not dt:
        return "-"
    if dt.tzinfo is None:
        dt = dt.replace(tzinfo=timezone.utc)
    local = dt.astimezone(LOCAL_TZ)
    weekday = WEEKDAY_JA[local.weekday()]
    return f"{local.year}年{local.month:02d}月{local.day:02d}日({weekday}) {local.hour:02d}:{local.minute:02d}:{local.second:02d}"
```

### 実働時間の計算

**ファイル位置**: `app.py` 104-111行目

```python
def worked_seconds(self, now=None):
    """実働時間を秒で返す"""
    if now is None:
        now = datetime.now(timezone.utc)
    start = ensure_aware(self.clock_in_at)
    end = ensure_aware(self.clock_out_at) if self.clock_out_at else ensure_aware(now)
    total = max(0, int((end - start).total_seconds()))
    total -= self.total_break_seconds(now=now)
    return max(0, total)
```

## IPアドレス・User-Agentの記録

すべての操作でIPアドレスとUser-Agentを記録します。

**ヘルパー関数**:
```python
def client_ip():
    """クライアントIPを取得（X-Forwarded-For対応）"""
    xff = request.headers.get("X-Forwarded-For")
    if xff:
        return xff.split(",")[0].strip()
    return request.remote_addr or "?"

def user_agent():
    """User-Agentを取得"""
    return request.headers.get("User-Agent", "?")[:300]
```

**ファイル位置**: `app.py` 178-185行目

## 監査ログ

すべての出退勤操作は監査ログに記録されます。

- `clock_in`: 出勤
- `clock_out`: 退勤
- `break_start`: 休憩開始
- `break_end`: 休憩終了

**記録内容**:
- ユーザーID
- 操作時刻
- IPアドレス
- User-Agent
- HMAC署名

## 関連機能

- [管理者機能（出退勤記録管理）](04-管理者機能（出退勤記録管理）.md) - 管理者による記録の編集
- [データベース構造](09-データベース構造.md) - データモデルの詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの仕組み

