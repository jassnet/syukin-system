# システム設定機能

## 概要

管理者がシステムの各種設定を変更できる機能です。設定はデータベースに保存され、環境変数よりも優先されます。

## アクセス制御

管理者のみアクセス可能です。

**権限チェック**: `require_admin()` を使用

## 設定画面

### エンドポイント

**GET /admin/settings**（設定表示）
**POST /admin/settings**（設定更新）

**ファイル位置**: `app.py` 791-859行目

**認証**: ログイン必須 + 管理者権限

### テンプレート

**ファイル位置**: `templates/admin_settings.html`

## 設定項目

### CSVエクスポート設定

#### CSV_EXPORT_EMAIL
- **説明**: 定期CSV送信の送信先メールアドレス
- **型**: 文字列
- **デフォルト**: 空文字列（無効）
- **環境変数**: `CSV_EXPORT_EMAIL`

#### CSV_EXPORT_SCHEDULE
- **説明**: CSV送信のスケジュール
- **型**: 文字列
- **値**:
  - `daily`: 毎日朝9時
  - `weekly`: 毎週月曜日朝9時
  - `monthly`: 毎月1日朝9時
  - cron形式: `0 9 * * *`（毎日9時）
- **デフォルト**: 空文字列（無効）
- **環境変数**: `CSV_EXPORT_SCHEDULE`

#### CSV_EXPORT_DAYS
- **説明**: 過去何日分をエクスポートするか
- **型**: 整数
- **デフォルト**: 30
- **環境変数**: `CSV_EXPORT_DAYS`

### SMTP設定

#### SMTP_HOST
- **説明**: SMTPサーバーのホスト名
- **型**: 文字列
- **デフォルト**: `localhost`
- **環境変数**: `SMTP_HOST`

#### SMTP_PORT
- **説明**: SMTPサーバーのポート番号
- **型**: 整数（文字列として保存）
- **デフォルト**: `25`
- **環境変数**: `SMTP_PORT`

#### SMTP_USER
- **説明**: SMTP認証ユーザー名
- **型**: 文字列
- **デフォルト**: 空文字列
- **環境変数**: `SMTP_USER`

#### SMTP_PASSWORD
- **説明**: SMTP認証パスワード
- **型**: 文字列（平文で保存）
- **デフォルト**: 空文字列
- **環境変数**: `SMTP_PASSWORD`

#### SMTP_USE_TLS
- **説明**: TLS/SSLを使用するか
- **型**: ブール値（文字列として保存: "true"/"false"）
- **デフォルト**: `false`
- **環境変数**: `SMTP_USE_TLS`

#### SMTP_FROM
- **説明**: 送信元メールアドレス
- **型**: 文字列
- **デフォルト**: SMTP_USERまたは`noreply@example.com`
- **環境変数**: `SMTP_FROM`

## 設定モデル

### SystemConfigクラス

**ファイル位置**: `app.py` 138-176行目

```python
class SystemConfig(db.Model):
    __tablename__ = "system_configs"
    id = db.Column(db.Integer, primary_key=True)
    key = db.Column(db.String(100), unique=True, nullable=False, index=True)
    value = db.Column(db.Text)
    updated_at = db.Column(db.DateTime(timezone=True))
    updated_by = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=True)
```

### 静的メソッド

#### get(key, default=None)
設定値を取得（DB優先、環境変数フォールバック）

```python
@staticmethod
def get(key, default=None):
    config = SystemConfig.query.filter_by(key=key).first()
    if config and config.value:
        return config.value
    return os.getenv(key, default)
```

#### set(key, value, user_id=None)
設定値を保存

```python
@staticmethod
def set(key, value, user_id=None):
    config = SystemConfig.query.filter_by(key=key).first()
    if config:
        config.value = value
        config.updated_at = datetime.now(timezone.utc)
        config.updated_by = user_id
    else:
        config = SystemConfig(key=key, value=value, updated_by=user_id)
        db.session.add(config)
    db.session.commit()
    return config
```

#### get_all()
すべての設定を辞書形式で取得

```python
@staticmethod
def get_all():
    configs = SystemConfig.query.all()
    result = {}
    for config in configs:
        result[config.key] = config.value
    return result
```

## 設定の優先順位

1. **データベース（SystemConfig）**: 最優先
2. **環境変数**: データベースに値がない場合のフォールバック

この仕組みにより、環境変数でデフォルト値を設定しつつ、管理画面で変更可能です。

## 更新処理

### 処理フロー

**ファイル位置**: `app.py` 828-874行目

```
1. CSRFトークン検証
2. フォームデータ取得
3. SystemConfig.set()で各設定を保存
4. スケジューラーを更新（update_scheduler）
5. 監査ログ記録
6. フラッシュメッセージ表示
7. 設定画面へリダイレクト
```

### スケジューラーの更新

CSV送信スケジュールを変更した場合、APSchedulerを再起動します。

**ファイル位置**: `app.py` 947-978行目

```python
def update_scheduler():
    """スケジューラーを更新（設定変更時に呼び出し）"""
    global _scheduler
    
    # 既存のスケジューラーを停止
    if _scheduler:
        _scheduler.shutdown(wait=False)
        _scheduler = None
    
    # 設定を取得
    email, schedule, days = get_csv_export_config()
    
    # 設定がない場合はスケジューラーを起動しない
    if not email or not schedule:
        return
    
    # 新しいスケジューラーを起動
    trigger = get_trigger_from_schedule(schedule)
    _scheduler = BackgroundScheduler()
    _scheduler.add_job(func=scheduled_csv_export, trigger=trigger, ...)
    _scheduler.start()
```

## スケジュール形式

### プリセット値

**ファイル位置**: `app.py` 915-945行目

- **daily**: 毎日朝9時
  ```python
  CronTrigger(hour=9, minute=0, timezone=LOCAL_TZ)
  ```

- **weekly**: 毎週月曜日朝9時
  ```python
  CronTrigger(day_of_week="mon", hour=9, minute=0, timezone=LOCAL_TZ)
  ```

- **monthly**: 毎月1日朝9時
  ```python
  CronTrigger(day=1, hour=9, minute=0, timezone=LOCAL_TZ)
  ```

### Cron形式

5つの値（分、時、日、月、曜日）をスペース区切りで指定:

```
0 9 * * *  # 毎日9時
0 0 1 * *  # 毎月1日0時
0 9 * * 1  # 毎週月曜日9時
```

## 監査ログ

設定変更はすべて監査ログに記録されます。

```python
log_audit("admin_settings_update", target_type="system", target_id=None,
         metadata_dict={"updated_keys": ["CSV_EXPORT_EMAIL", "CSV_EXPORT_SCHEDULE", ...]})
```

**ファイル位置**: `app.py` 865-867行目

## 初期化

アプリ起動時にスケジューラーを初期化します。

**ファイル位置**: `app.py` 980-988行目

```python
def init_scheduler():
    """スケジューラーを初期化（起動時）"""
    update_scheduler()

# アプリ起動時にスケジューラーを初期化
try:
    init_scheduler()
except Exception as e:
    app.logger.exception(f"Failed to initialize scheduler: {e}")
```

## エラーハンドリング

設定の保存に失敗した場合:

```python
try:
    SystemConfig.set(...)
except Exception as e:
    db.session.rollback()
    app.logger.exception(f"Failed to save settings: {e}")
    flash("設定の保存に失敗しました。", "error")
```

## セキュリティ考慮事項

### パスワードの保存

- **SMTP_PASSWORD**: 平文で保存されています
- **推奨**: 必要に応じて暗号化を検討してください

### 入力検証

現バージョンでは基本的な検証のみです。必要に応じて以下を追加してください:

- メールアドレスの形式チェック
- ポート番号の範囲チェック
- cron形式の構文チェック

## 関連機能

- [CSVエクスポート機能](08-CSVエクスポート機能.md) - CSV送信の詳細
- [データベース構造](09-データベース構造.md) - SystemConfigモデルの詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの詳細

