# 管理者機能（出退勤記録管理）

## 概要

管理者が全ユーザーの出退勤記録を閲覧・検索・編集できる機能です。

## アクセス制御

管理者のみアクセス可能です。

**権限チェック**:
```python
def require_admin():
    if not (current_user.is_authenticated and current_user.is_admin()):
        abort(403, "管理者のみアクセス可能です。")
```

**ファイル位置**: `app.py` 379-381行目

## 出退勤記録一覧

### エンドポイント

**GET /admin**

**ファイル位置**: `app.py` 383-432行目

**認証**: ログイン必須 + 管理者権限

### 検索・フィルタ機能

1. **期間指定**
   - 開始日（start）
   - 終了日（end）
   - デフォルト: 過去14日間

2. **ユーザーIDフィルタ**
   - 特定ユーザーの記録のみ表示
   - オートコンプリート対応

### 表示内容

1. **日別集計**
   - 日付ごとの実働時間合計
   - シフト数
   - 全体の合計

2. **シフト一覧**
   - ユーザー名・ユーザーID
   - 出勤時刻・退勤時刻
   - 実働時間・休憩時間
   - IPアドレス（出勤/退勤）
   - 編集ボタン

### テンプレート

**ファイル位置**: `templates/admin.html`

**主要な変数**:
- `shifts`: Shiftオブジェクトのリスト
- `start`: 開始日（ISO形式）
- `end`: 終了日（ISO形式）
- `user_username`: フィルタ用ユーザーID
- `daily_totals`: 日別集計データ
- `user_candidates`: ユーザー候補リスト（オートコンプリート用）

## 出退勤記録の編集

### 編集画面（モーダル）

**JavaScript機能**: `templates/admin.html` 内のJavaScript

**機能**:
- モーダルで編集フォームを表示
- 出勤時刻・退勤時刻の編集
- 時刻ショートカット（現在時刻、±15分、5分単位に丸める）
- リアルタイムで実働時間を計算表示

### 編集API

**GET /admin/shift/<shift_id>**

**ファイル位置**: `app.py` 633-666行目

**レスポンス**: JSON形式

```json
{
  "id": 1,
  "user_username": "user001",
  "user_email": "user@example.com",
  "user_name": "ユーザー名",
  "clock_in_at": "2024-01-01 09:00:00",
  "clock_out_at": "2024-01-01 18:00:00",
  "clock_in_form": "2024-01-01T09:00",
  "clock_out_form": "2024-01-01T18:00",
  "clock_in_utc": "2024-01-01T00:00:00+00:00",
  "clock_out_utc": "2024-01-01T09:00:00+00:00",
  "worked_seconds": 32400,
  "worked_hms": "09:00:00",
  "break_count": 1,
  "break_seconds": 3600,
  "break_hms": "01:00:00"
}
```

### 更新処理

**POST /admin/shift/<shift_id>/edit**

**ファイル位置**: `app.py` 568-632行目

**処理フロー**:
```
1. CSRFトークン検証
2. Shiftレコードを取得
3. 変更前の値を保存（監査ログ用）
4. フォームから新しい時刻を取得
5. ローカル時刻からUTCに変換
6. DB更新
7. 変更後の値を保存
8. 監査ログ記録（変更前後の値を含む）
9. フラッシュメッセージ表示
10. 管理画面へリダイレクト
```

**入力形式**:
- `datetime-local`形式: `YYYY-MM-DDTHH:MM`
- または: `YYYY-MM-DD HH:MM:SS`

**時刻変換**:
```python
# ローカル時刻をUTCに変換
clock_in_local = datetime.strptime(clock_in_str, "%Y-%m-%dT%H:%M")
shift.clock_in_at = clock_in_local.replace(tzinfo=LOCAL_TZ).astimezone(timezone.utc)
```

### 詳細画面

**GET /admin/shift/<shift_id>**（詳細表示用）

**ファイル位置**: `templates/admin.html` のリンク

通常はモーダルで編集しますが、詳細画面でも編集可能です。

**テンプレート**: `templates/shift_edit.html`

## CSVエクスポート

### エンドポイント

**GET /admin/export**

**ファイル位置**: `app.py` 467-487行目

**クエリパラメータ**:
- `start`: 開始日（YYYY-MM-DD）
- `end`: 終了日（YYYY-MM-DD）
- `username`: ユーザーIDフィルタ（オプション）

### CSV形式

**ヘッダー**:
```
user_username,user_email,user_name,shift_id,clock_in_local,clock_out_local,worked_seconds,worked_hms,clock_in_utc,clock_out_utc,clock_in_ip,clock_out_ip,clock_in_ua,clock_out_ua,break_count,breaks_total_seconds,breaks_total_hms
```

**ファイル名**: `attendance_export_YYYY-MM-DD_YYYY-MM-DD.csv`

**文字コード**: UTF-8 with BOM (`utf-8-sig`)

### 生成関数

**ファイル位置**: `app.py` 434-465行目

```python
def generate_csv(start_date, end_date, user_username=None, user_email=None):
    """CSVデータを生成する共通関数"""
    # Shiftクエリ作成
    # CSVデータ生成
    # バイト列として返す
```

## 監査ログ

編集操作はすべて監査ログに記録されます。

**記録内容**:
```python
log_audit("admin_shift_edit", target_type="shift", target_id=shift_id,
         metadata_dict={
             "user_username": shift.user.username,
             "user_email": shift.user.email or "",
             "old_values": {
                 "clock_in_at": "...",
                 "clock_out_at": "..."
             },
             "new_values": {
                 "clock_in_at": "...",
                 "clock_out_at": "..."
             }
         })
```

**ファイル位置**: `app.py` 612-619行目

変更前後の値が記録されるため、監査要件を満たしています。

## 時刻の扱い

### 保存形式
- **データベース**: UTC（timezone aware）

### 表示形式
- **一覧画面**: ローカル時刻（`fmt_dt`フィルタ）
- **編集フォーム**: `datetime-local`形式（ローカル時刻）
- **JSON API**: ローカル時刻文字列 + UTC ISO形式

### 変換処理

**ローカル → UTC**:
```python
local_dt = datetime.strptime(form_value, "%Y-%m-%dT%H:%M")
utc_dt = local_dt.replace(tzinfo=LOCAL_TZ).astimezone(timezone.utc)
```

**UTC → ローカル**:
```python
local_dt = utc_dt.astimezone(LOCAL_TZ)
form_value = local_dt.strftime("%Y-%m-%dT%H:%M")
```

## 関連機能

- [ユーザー管理機能](05-ユーザー管理機能.md) - ユーザーの管理
- [CSVエクスポート機能](08-CSVエクスポート機能.md) - CSVエクスポートの詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの詳細
- [データベース構造](09-データベース構造.md) - Shiftモデルの詳細

