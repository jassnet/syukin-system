# データベース構造

## 概要

SQLAlchemy ORMを使用したデータベース設計です。開発環境ではSQLite、本番環境ではPostgreSQLを使用します。

## テーブル一覧

1. **users**: ユーザー情報
2. **shifts**: 出退勤記録
3. **breaks**: 休憩記録
4. **audit_logs**: 監査ログ
5. **system_configs**: システム設定

## usersテーブル

### 定義

**ファイル位置**: `app.py` 54-76行目

```python
class User(db.Model, UserMixin):
    __tablename__ = "users"
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(100), unique=True, nullable=False, index=True)
    password_hash = db.Column(db.String(255), nullable=False)
    email = db.Column(db.String(320), unique=True, nullable=True, index=True)
    name = db.Column(db.String(200))
    picture = db.Column(db.String(500))
    role = db.Column(db.String(20), default="user")
    created_at = db.Column(db.DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    last_login_at = db.Column(db.DateTime(timezone=True))
    shifts = db.relationship("Shift", backref="user", lazy=True)
```

### カラム詳細

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | Integer | PK | 主キー |
| username | String(100) | UNIQUE, NOT NULL, INDEX | ユーザーID |
| password_hash | String(255) | NOT NULL | パスワードハッシュ |
| email | String(320) | UNIQUE, NULL可, INDEX | メールアドレス |
| name | String(200) | NULL可 | 氏名 |
| picture | String(500) | NULL可 | 画像URL（将来の拡張用） |
| role | String(20) | DEFAULT 'user' | 権限（user/admin） |
| created_at | DateTime(timezone) | DEFAULT 現在時刻 | 作成日時（UTC） |
| last_login_at | DateTime(timezone) | NULL可 | 最終ログイン日時（UTC） |

### リレーションシップ

- **User → Shift**: 1対多（`shifts`リレーションシップ）
- **User → AuditLog**: 1対多（`audit_logs`リレーションシップ）

## shiftsテーブル

### 定義

**ファイル位置**: `app.py` 78-111行目

```python
class Shift(db.Model):
    __tablename__ = "shifts"
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=False, index=True)
    clock_in_at = db.Column(db.DateTime(timezone=True), nullable=False)
    clock_out_at = db.Column(db.DateTime(timezone=True), nullable=True)
    clock_in_ip = db.Column(db.String(100))
    clock_in_ua = db.Column(db.String(300))
    clock_out_ip = db.Column(db.String(100))
    clock_out_ua = db.Column(db.String(300))
    created_at = db.Column(db.DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    breaks = db.relationship("Break", backref="shift", lazy=True, cascade="all, delete-orphan")
```

### カラム詳細

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | Integer | PK | 主キー |
| user_id | Integer | FK(users.id), NOT NULL, INDEX | ユーザーID |
| clock_in_at | DateTime(timezone) | NOT NULL | 出勤時刻（UTC） |
| clock_out_at | DateTime(timezone) | NULL可 | 退勤時刻（UTC） |
| clock_in_ip | String(100) | NULL可 | 出勤時のIPアドレス |
| clock_in_ua | String(300) | NULL可 | 出勤時のUser-Agent |
| clock_out_ip | String(100) | NULL可 | 退勤時のIPアドレス |
| clock_out_ua | String(300) | NULL可 | 退勤時のUser-Agent |
| created_at | DateTime(timezone) | DEFAULT 現在時刻 | 作成日時（UTC） |

### プロパティ

- **is_open**: 出勤中かどうか（`clock_out_at is None`）
- **total_break_seconds()**: 休憩時間の合計（秒）
- **worked_seconds()**: 実働時間（秒）

### リレーションシップ

- **Shift → User**: 多対1（`user`バックリファレンス）
- **Shift → Break**: 1対多（`breaks`リレーションシップ、CASCADE削除）

## breaksテーブル

### 定義

**ファイル位置**: `app.py` 113-122行目

```python
class Break(db.Model):
    __tablename__ = "breaks"
    id = db.Column(db.Integer, primary_key=True)
    shift_id = db.Column(db.Integer, db.ForeignKey("shifts.id"), nullable=False, index=True)
    start_at = db.Column(db.DateTime(timezone=True), nullable=False)
    end_at = db.Column(db.DateTime(timezone=True), nullable=True)
    start_ip = db.Column(db.String(100))
    start_ua = db.Column(db.String(300))
    end_ip = db.Column(db.String(100))
    end_ua = db.Column(db.String(300))
```

### カラム詳細

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | Integer | PK | 主キー |
| shift_id | Integer | FK(shifts.id), NOT NULL, INDEX | シフトID |
| start_at | DateTime(timezone) | NOT NULL | 休憩開始時刻（UTC） |
| end_at | DateTime(timezone) | NULL可 | 休憩終了時刻（UTC） |
| start_ip | String(100) | NULL可 | 休憩開始時のIPアドレス |
| start_ua | String(300) | NULL可 | 休憩開始時のUser-Agent |
| end_ip | String(100) | NULL可 | 休憩終了時のIPアドレス |
| end_ua | String(300) | NULL可 | 休憩終了時のUser-Agent |

### リレーションシップ

- **Break → Shift**: 多対1（`shift`バックリファレンス）

## audit_logsテーブル

### 定義

**ファイル位置**: `app.py` 124-136行目

```python
class AuditLog(db.Model):
    __tablename__ = "audit_logs"
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=True, index=True)
    user = db.relationship("User", backref="audit_logs")
    action = db.Column(db.String(50), nullable=False)
    target_type = db.Column(db.String(50))
    target_id = db.Column(db.Integer)
    ip = db.Column(db.String(100))
    user_agent = db.Column(db.String(300))
    metadata_json = db.Column(db.Text)
    created_at = db.Column(db.DateTime(timezone=True), default=lambda: datetime.now(timezone.utc))
    signature = db.Column(db.String(128))
```

### カラム詳細

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | Integer | PK | 主キー |
| user_id | Integer | FK(users.id), NULL可, INDEX | 操作を行ったユーザーID |
| action | String(50) | NOT NULL | 操作の種類 |
| target_type | String(50) | NULL可 | 操作対象のタイプ |
| target_id | Integer | NULL可 | 操作対象のID |
| ip | String(100) | NULL可 | クライアントIPアドレス |
| user_agent | String(300) | NULL可 | User-Agent |
| metadata_json | Text | NULL可 | 追加情報（JSON形式） |
| created_at | DateTime(timezone) | DEFAULT 現在時刻 | 記録日時（UTC） |
| signature | String(128) | NULL可 | HMAC署名 |

### リレーションシップ

- **AuditLog → User**: 多対1（`user`リレーションシップ）

## system_configsテーブル

### 定義

**ファイル位置**: `app.py` 138-176行目

```python
class SystemConfig(db.Model):
    __tablename__ = "system_configs"
    id = db.Column(db.Integer, primary_key=True)
    key = db.Column(db.String(100), unique=True, nullable=False, index=True)
    value = db.Column(db.Text)
    updated_at = db.Column(db.DateTime(timezone=True), default=lambda: datetime.now(timezone.utc), onupdate=lambda: datetime.now(timezone.utc))
    updated_by = db.Column(db.Integer, db.ForeignKey("users.id"), nullable=True)
```

### カラム詳細

| カラム名 | 型 | 制約 | 説明 |
|---------|-----|------|------|
| id | Integer | PK | 主キー |
| key | String(100) | UNIQUE, NOT NULL, INDEX | 設定キー |
| value | Text | NULL可 | 設定値 |
| updated_at | DateTime(timezone) | DEFAULT/ON UPDATE 現在時刻 | 更新日時（UTC） |
| updated_by | Integer | FK(users.id), NULL可 | 更新者ID |

## インデックス

### 自動インデックス

- `users.username`: UNIQUE制約により自動インデックス
- `users.email`: UNIQUE制約により自動インデックス
- `users.id`: 主キーにより自動インデックス
- `shifts.user_id`: FOREIGN KEYにより自動インデックス
- `shifts.id`: 主キーにより自動インデックス
- `breaks.shift_id`: FOREIGN KEYにより自動インデックス
- `audit_logs.user_id`: 明示的なインデックス

### 推奨インデックス（将来の拡張）

- `shifts.clock_in_at`: 日付範囲検索のパフォーマンス向上
- `audit_logs.created_at`: 時系列ソートのパフォーマンス向上
- `audit_logs.action`: アクションフィルタのパフォーマンス向上

## 外部キー制約

- `shifts.user_id` → `users.id`
- `breaks.shift_id` → `shifts.id`
- `audit_logs.user_id` → `users.id`
- `system_configs.updated_by` → `users.id`

## CASCADE削除

- **User削除時**: 関連するShift、Break、AuditLogは削除されない（NULL可のため）
- **Shift削除時**: 関連するBreakはCASCADE削除（`cascade="all, delete-orphan"`）

## データベース初期化

### 自動作成

`app.before_request`でテーブルを自動作成:

```python
@app.before_request
def ensure_db():
    db.create_all()
```

**ファイル位置**: `app.py` 950-952行目

### 手動マイグレーション

現バージョンではAlembicなどのマイグレーションツールは使用していません。スキーマ変更時は手動で対応してください。

## 関連機能

- [システム概要](01-システム概要.md) - 全体構成
- [API・ルーティング](10-API・ルーティング.md) - エンドポイント一覧

