# セキュリティ

## 概要

出退勤システムのセキュリティ対策について説明します。

## 認証・認可

### パスワードハッシュ化

**アルゴリズム**: PBKDF2（Werkzeug標準）

**実装**:
```python
from werkzeug.security import generate_password_hash, check_password_hash

def set_password(self, password):
    self.password_hash = generate_password_hash(password)

def check_password(self, password):
    return check_password_hash(self.password_hash, password)
```

**ファイル位置**: `app.py` 67-73行目

**特徴**:
- ソルト自動生成
- 複数回のハッシュ処理（イテレーション）
- タイミング攻撃対策（`secrets.compare_digest`使用）

### セッション管理

**ライブラリ**: Flask-Login

**設定**:
```python
app.config["SESSION_COOKIE_HTTPONLY"] = True
app.config["SESSION_COOKIE_SAMESITE"] = "Lax"
app.config["SESSION_COOKIE_SECURE"] = env_bool("SESSION_COOKIE_SECURE", False)
```

**ファイル位置**: `app.py` 37-39行目

**セキュリティ機能**:
- **HttpOnly**: JavaScriptからCookieにアクセス不可（XSS対策）
- **SameSite=Lax**: CSRF対策の一部
- **Secure**: HTTPS時のみCookie送信（本番環境で推奨）

### 権限管理

**ロールベースアクセス制御（RBAC）**:
- **user**: 一般ユーザー（自分のデータのみ）
- **admin**: 管理者（すべてのデータにアクセス可能）

**権限チェック**:
```python
def require_admin():
    if not (current_user.is_authenticated and current_user.is_admin()):
        abort(403, "管理者のみアクセス可能です。")
```

**ファイル位置**: `app.py` 379-381行目

## CSRF保護

### 実装

**ファイル位置**: `app.py` 217-228行目

```python
def ensure_csrf():
    """CSRFトークンをセッションに保存"""
    tok = session.get("csrf_token")
    if not tok:
        tok = secrets.token_urlsafe(32)
        session["csrf_token"] = tok
    return tok

def verify_csrf():
    """CSRFトークンを検証"""
    form_tok = request.form.get("csrf_token", "")
    ok = form_tok and session.get("csrf_token") and secrets.compare_digest(form_tok, session["csrf_token"])
    if not ok:
        abort(400, "CSRF token missing or invalid")
```

### 使用方法

1. **GETリクエスト時**: `ensure_csrf()`でトークン生成
2. **テンプレート**: `{{ session.csrf_token }}`をhiddenフィールドに設定
3. **POSTリクエスト時**: `verify_csrf()`で検証

### タイミング攻撃対策

`secrets.compare_digest()`を使用してタイミング攻撃を防止しています。

## 入力検証

### 基本検証

- **必須フィールド**: フォームレベルで検証
- **データ型**: SQLAlchemyが型チェック
- **文字列長**: データベース制約で制限

### SQLインジェクション対策

**SQLAlchemy ORM使用**: クエリパラメータは自動的にエスケープされます。

```python
# 安全なクエリ
user = User.query.filter_by(username=username).first()
```

### XSS対策

**Jinja2自動エスケープ**: テンプレート変数は自動的にエスケープされます。

**手動エスケープが必要な場合**:
```jinja2
{{ user_input|safe }}  # エスケープを無効化（注意が必要）
```

## 監査ログ

### HMAC署名

**ファイル位置**: `app.py` 187-189行目

```python
def sign_payload(payload: str) -> str:
    key = (app.config["SECRET_KEY"]).encode("utf-8")
    return hmac.new(key, payload.encode("utf-8"), hashlib.sha256).hexdigest()
```

**署名対象データ**:
```
{action}|{target_type}|{target_id}|{metadata_json}
```

**改ざん検知**: 署名を再計算して比較することで検証可能

### 記録内容

すべての操作で以下を記録:
- ユーザーID
- 操作時刻
- IPアドレス
- User-Agent
- 操作内容（JSON形式）
- HMAC署名

## プロキシ対応

### X-Forwarded-For対応

**ファイル位置**: `app.py` 178-182行目

```python
def client_ip():
    """クライアントIPを取得（X-Forwarded-For対応）"""
    xff = request.headers.get("X-Forwarded-For")
    if xff:
        return xff.split(",")[0].strip()
    return request.remote_addr or "?"
```

**ProxyFix使用**:
```python
from werkzeug.middleware.proxy_fix import ProxyFix
app.wsgi_app = ProxyFix(app.wsgi_app, x_for=1, x_host=1, x_proto=1)
```

**ファイル位置**: `app.py` 29行目

## セキュリティ設定

### SECRET_KEY

**用途**:
- セッション暗号化
- CSRFトークン生成
- HMAC署名

**要件**:
- 十分な長さ（推奨: 32文字以上）
- ランダムな値
- 本番環境では環境変数で設定

**生成方法**:
```python
import secrets
secret_key = secrets.token_urlsafe(32)
```

### HTTPS推奨

**本番環境では必ずHTTPSを使用**:
- `SESSION_COOKIE_SECURE=true`を設定
- SSL/TLS証明書を設定

## パスワードポリシー

### 現バージョンの制限

- **最小長**: 実装なし（任意の長さ）
- **複雑さ**: 実装なし（任意の文字列）
- **有効期限**: 実装なし（無期限）

### 推奨事項

必要に応じて以下を実装:
- 最小8文字以上
- 大文字・小文字・数字・記号を含む
- 定期的なパスワード変更
- パスワード履歴管理

## ブルートフォース対策

### 現バージョン

- **実装なし**: ログイン試行回数制限なし

### 推奨事項

必要に応じて以下を実装:
- ログイン試行回数制限（例: 5回）
- アカウントロック（一定時間）
- CAPTCHA（試行回数超過時）

## データ保護

### 暗号化

- **パスワード**: ハッシュ化（PBKDF2）
- **セッション**: Flaskが暗号化

### バックアップ

- **推奨**: 定期的なデータベースバックアップ
- **保存場所**: 安全な場所に保管
- **暗号化**: バックアップファイルも暗号化推奨

## 関連機能

- [認証・ログイン機能](02-認証・ログイン機能.md) - 認証の詳細
- [監査ログ機能](06-監査ログ機能.md) - 監査ログの詳細

