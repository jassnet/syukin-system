{% extends "layout.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2">
      <div>
        <h2 class="h5 mb-0">管理 - 出退勤記録</h2>
        <div class="text-muted small">表示タイムゾーン: {{ LOCAL_TZ_NAME }}</div>
      </div>
      <div class="d-flex gap-2 flex-wrap">
        <a class="btn btn-outline-success" href="{{ url_for('admin_users') }}">ユーザー管理</a>
        <a class="btn btn-outline-primary" href="{{ url_for('admin_audit') }}">監査ログ</a>
        <a class="btn btn-outline-info" href="{{ url_for('admin_settings') }}">設定</a>
        <a class="btn btn-outline-secondary" href="{{ url_for('admin_export', start=start, end=end, username=user_username) }}">CSVエクスポート</a>
      </div>
    </div>

    <form class="row row-cols-1 row-cols-md-4 g-3 align-items-end mt-3" method="get">
      <div class="col">
        <label class="form-label">開始日</label>
        <input type="date" class="form-control" name="start" value="{{ start }}">
      </div>
      <div class="col">
        <label class="form-label">終了日</label>
        <input type="date" class="form-control" name="end" value="{{ end }}">
      </div>
      <div class="col">
        <label class="form-label">ユーザーID（任意）</label>
        <input type="text" class="form-control" name="username" value="{{ user_username }}" list="admin-username-list" placeholder="username">
        <datalist id="admin-username-list">
          {% for user in user_candidates %}
          <option value="{{ user.username }}">{{ user.name or user.username }}</option>
          {% endfor %}
        </datalist>
      </div>
      <div class="col d-flex flex-column flex-md-row gap-2">
        <button class="btn btn-primary w-100 w-md-auto">表示更新</button>
        <a class="btn btn-outline-secondary w-100 w-md-auto" href="{{ url_for('admin') }}">リセット</a>
      </div>
    </form>

    <div class="mt-4">
      <div class="border rounded p-3 bg-light-subtle">
        <h3 class="h6 mb-3">手動で出退勤を追加</h3>
        <form class="row gy-3 align-items-end" method="POST" action="{{ url_for('admin_shift_create') }}">
          <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
          <input type="hidden" name="start" value="{{ start }}">
          <input type="hidden" name="end" value="{{ end }}">
          <input type="hidden" name="username" value="{{ user_username }}">
          <div class="col-md-3">
            <label class="form-label">ユーザー</label>
            <select name="user_id" class="form-select" required>
              <option value="" disabled selected>選択してください</option>
              {% for user in user_candidates %}
              <option value="{{ user.id }}">{{ user.name or user.username }} ({{ user.username }})</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">出勤 ({{ LOCAL_TZ_NAME }})</label>
            <input type="datetime-local" name="clock_in_at" class="form-control" required>
          </div>
          <div class="col-md-3">
            <label class="form-label">退勤 (任意)</label>
            <input type="datetime-local" name="clock_out_at" class="form-control">
          </div>
          <div class="col-md-3 d-grid">
            <button type="submit" class="btn btn-outline-primary">追加</button>
          </div>
        </form>
        <p class="text-muted small mb-0 mt-2">退勤を空にすると「出勤中」のシフトを作成できます。値は監査ログに記録されます。</p>
      </div>
    </div>

    {% set ns = namespace(total_seconds=0, total_shifts=0) %}
    {% for day in daily_totals %}
      {% set ns.total_seconds = ns.total_seconds + day.seconds %}
      {% set ns.total_shifts = ns.total_shifts + day.count %}
    {% endfor %}
    <div class="mt-4">
      <div class="d-flex flex-wrap align-items-baseline justify-content-between gap-2 mb-2">
        <h3 class="h6 mb-0">日別集計</h3>
        <div class="text-muted small">
          合計実働: {{ ns.total_seconds|fmt_hms }} ／ シフト数: {{ ns.total_shifts }}
        </div>
      </div>
      {% if daily_totals %}
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0 table-stack" aria-label="日別集計">
          <thead class="table-light">
            <tr>
              <th scope="col">日付</th>
              <th scope="col">シフト数</th>
              <th scope="col">実働合計</th>
            </tr>
          </thead>
          <tbody>
            {% for day in daily_totals %}
            <tr>
              <td data-label="日付">{{ day.date|fmt_date_ja }}</td>
              <td data-label="シフト数">{{ day.count }}</td>
              <td data-label="実働合計">{{ day.worked_hms }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="alert alert-light border mb-0">条件に一致するシフトがありません。</div>
      {% endif %}
    </div>

    <div class="table-responsive mt-4">
      <table class="table table-sm align-middle table-stack" aria-label="シフト一覧">
        <thead class="table-light">
          <tr>
            <th>ユーザー</th>
            <th>出勤</th>
            <th>退勤</th>
            <th>実働 / 休憩</th>
            <th>IP (in/out)</th>
            <th>操作</th>
          </tr>
        </thead>
      <tbody>
          {% for s in shifts %}
          <tr class="{% if s.is_open %}table-warning{% endif %}">
            <td data-label="ユーザー">
              <div class="fw-semibold">{{ s.user.name or s.user.username }}</div>
              <div class="text-muted small">{{ s.user.username }}{% if s.user.email %} ({{ s.user.email }}){% endif %}</div>
            </td>
            <td data-label="出勤">
              <div>{{ s.clock_in_at|fmt_dt }}</div>
              {% if s.is_open %}<span class="badge bg-warning-subtle text-warning-emphasis border">出勤中</span>{% endif %}
            </td>
            <td data-label="退勤">{{ s.clock_out_at|fmt_dt }}</td>
            <td data-label="実働 / 休憩">
              <div class="fw-semibold">{{ s.worked_seconds()|fmt_hms }}</div>
              <div class="text-muted small">休憩 {{ s.breaks|length }} / {{ s.total_break_seconds()|fmt_hms }}</div>
            </td>
            <td class="small" data-label="IP (in/out)">
              <div>{{ s.clock_in_ip or '-' }}</div>
              <div>{{ s.clock_out_ip or '-' }}</div>
            </td>
            <td data-label="操作">
              <div class="d-flex flex-column flex-lg-row gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary flex-fill" data-shift-edit="{{ s.id }}" data-detail-url="{{ url_for('admin_shift_detail', shift_id=s.id) }}" data-action-url="{{ url_for('admin_shift_edit', shift_id=s.id) }}">
                  編集
                </button>
                <a href="{{ url_for('admin_shift_edit', shift_id=s.id) }}" class="btn btn-sm btn-outline-secondary flex-fill">詳細画面</a>
                <form method="POST" action="{{ url_for('admin_shift_delete', shift_id=s.id) }}" class="flex-fill" onsubmit="return confirm('この出退勤記録を削除しますか？')">
                  <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
                  <input type="hidden" name="start" value="{{ start }}">
                  <input type="hidden" name="end" value="{{ end }}">
                  <input type="hidden" name="username" value="{{ user_username }}">
                  <button type="submit" class="btn btn-sm btn-outline-danger w-100">削除</button>
                </form>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="6" class="text-muted" data-label="検索結果">該当なし</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <p class="text-muted small mb-0 mt-3">
      * 保存はUTC、表示は {{ LOCAL_TZ_NAME }}。<br>
      * 各操作は監査ログ（IP/UA/HMAC）に記録されます。
    </p>
  </div>
</div>

<div class="modal fade" id="shiftEditModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <form method="POST" id="shiftEditForm">
        <div class="modal-header">
          <h5 class="modal-title">シフト編集</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="閉じる"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
          <div class="mb-3">
            <div class="fw-semibold" id="shiftEditUser">&nbsp;</div>
            <div class="text-muted small" id="shiftEditSummary">&nbsp;</div>
          </div>
          <div class="border rounded p-3 mb-3">
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">出勤時刻 ({{ LOCAL_TZ_NAME }})</label>
                <div class="d-flex gap-2">
                  <input type="datetime-local" class="form-control" id="shiftEditClockIn" name="clock_in_at" step="60">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-clear-target="#shiftEditClockIn">未設定</button>
                </div>
                <div class="btn-group btn-group-sm flex-wrap mt-2" role="group" aria-label="出勤時刻ショートカット">
                  <button type="button" class="btn btn-outline-secondary" data-set-now="#shiftEditClockIn">現在</button>
                  <button type="button" class="btn btn-outline-secondary" data-adjust-target="#shiftEditClockIn" data-adjust-minutes="-15">-15分</button>
                  <button type="button" class="btn btn-outline-secondary" data-adjust-target="#shiftEditClockIn" data-adjust-minutes="15">+15分</button>
                  <button type="button" class="btn btn-outline-secondary" data-round-target="#shiftEditClockIn" data-round-minutes="5">5分単位に丸める</button>
                </div>
                <div class="form-text" id="shiftEditClockInMeta"></div>
              </div>
              <div class="col-md-6">
                <label class="form-label">退勤時刻 ({{ LOCAL_TZ_NAME }})</label>
                <div class="d-flex gap-2">
                  <input type="datetime-local" class="form-control" id="shiftEditClockOut" name="clock_out_at" step="60">
                  <button type="button" class="btn btn-outline-secondary btn-sm" data-clear-target="#shiftEditClockOut">未設定</button>
                </div>
                <div class="btn-group btn-group-sm flex-wrap mt-2" role="group" aria-label="退勤時刻ショートカット">
                  <button type="button" class="btn btn-outline-secondary" data-set-now="#shiftEditClockOut">現在</button>
                  <button type="button" class="btn btn-outline-secondary" data-adjust-target="#shiftEditClockOut" data-adjust-minutes="-15">-15分</button>
                  <button type="button" class="btn btn-outline-secondary" data-adjust-target="#shiftEditClockOut" data-adjust-minutes="15">+15分</button>
                  <button type="button" class="btn btn-outline-secondary" data-copy-from="#shiftEditClockIn" data-copy-target="#shiftEditClockOut">出勤と同じ</button>
                  <button type="button" class="btn btn-outline-secondary" data-round-target="#shiftEditClockOut" data-round-minutes="5">5分単位に丸める</button>
                </div>
                <div class="form-text" id="shiftEditClockOutMeta"></div>
              </div>
            </div>
          </div>
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <div class="p-3 rounded bg-body-tertiary h-100">
                <div class="text-muted small">実働時間</div>
              <div class="fs-5" id="shiftEditWorked">--:--</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 rounded bg-body-tertiary h-100">
                <div class="text-muted small">休憩合計</div>
              <div class="fs-5" id="shiftEditBreaks">--:--</div>
                <div class="text-muted small" id="shiftEditBreakCount"></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 rounded bg-body-tertiary h-100">
                <div class="text-muted small">IP</div>
                <div class="small" id="shiftEditIp"></div>
              </div>
            </div>
          </div>
          <div class="alert alert-danger d-none" id="shiftEditError" role="alert"></div>
          <div class="text-center py-3 d-none" data-loading>
            <div class="spinner-border" role="status"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">閉じる</button>
          <button type="submit" class="btn btn-primary">更新</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const modalEl = document.getElementById('shiftEditModal');
  if (!modalEl) {
    return;
  }
  const modal = new bootstrap.Modal(modalEl);
  const form = document.getElementById('shiftEditForm');
  const clockInInput = document.getElementById('shiftEditClockIn');
  const clockOutInput = document.getElementById('shiftEditClockOut');
  const userLabel = document.getElementById('shiftEditUser');
  const summaryLabel = document.getElementById('shiftEditSummary');
  const workedLabel = document.getElementById('shiftEditWorked');
  const breaksLabel = document.getElementById('shiftEditBreaks');
  const breakCountLabel = document.getElementById('shiftEditBreakCount');
  const ipLabel = document.getElementById('shiftEditIp');
  const errorBox = document.getElementById('shiftEditError');
  const loadingBox = modalEl.querySelector('[data-loading]');
  const clockInMeta = document.getElementById('shiftEditClockInMeta');
  const clockOutMeta = document.getElementById('shiftEditClockOutMeta');

  const toggleLoading = (state) => {
    if (!loadingBox) return;
    loadingBox.classList.toggle('d-none', !state);
  };

  const pad2 = (num) => String(num).padStart(2, '0');

  const formatForInput = (date) => {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
      return '';
    }
    return `${date.getFullYear()}-${pad2(date.getMonth() + 1)}-${pad2(date.getDate())}T${pad2(date.getHours())}:${pad2(date.getMinutes())}`;
  };

  const parseInputValue = (value) => {
    if (!value) return null;
    const parsed = new Date(value);
    return Number.isNaN(parsed.getTime()) ? null : parsed;
  };

  const setInputDate = (input, dateObj) => {
    if (!input || !(dateObj instanceof Date) || Number.isNaN(dateObj.getTime())) {
      return;
    }
    input.value = formatForInput(dateObj);
    input.dispatchEvent(new Event('change', { bubbles: true }));
    input.dispatchEvent(new Event('input', { bubbles: true }));
  };

  const adjustInputMinutes = (input, minutes) => {
    if (!input) return;
    const base = parseInputValue(input.value) || new Date();
    base.setMinutes(base.getMinutes() + minutes);
    setInputDate(input, base);
  };

  const roundInputMinutes = (input, stepMinutes) => {
    if (!input || !stepMinutes) return;
    const base = parseInputValue(input.value) || new Date();
    const ms = base.getTime();
    const stepMs = stepMinutes * 60 * 1000;
    const rounded = new Date(Math.round(ms / stepMs) * stepMs);
    setInputDate(input, rounded);
  };

  const buildMetaText = (local, utc) => {
    if (!local && !utc) {
      return '未設定';
    }
    if (local && utc) {
      return `${local} (UTC: ${utc})`;
    }
    return local || `UTC: ${utc}`;
  };

  const showError = (message) => {
    errorBox.textContent = message;
    errorBox.classList.toggle('d-none', !message);
  };

  modalEl.querySelectorAll('[data-clear-target]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = modalEl.querySelector(btn.getAttribute('data-clear-target'));
      if (target) {
        target.value = '';
        target.dispatchEvent(new Event('change', { bubbles: true }));
        target.dispatchEvent(new Event('input', { bubbles: true }));
      }
    });
  });

  modalEl.querySelectorAll('[data-set-now]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = modalEl.querySelector(btn.getAttribute('data-set-now'));
      if (target) {
        setInputDate(target, new Date());
      }
    });
  });

  modalEl.querySelectorAll('[data-adjust-minutes]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const selector = btn.getAttribute('data-adjust-target');
      const target = modalEl.querySelector(selector);
      if (!target) return;
      const minutes = Number(btn.getAttribute('data-adjust-minutes'));
      if (Number.isNaN(minutes)) return;
      adjustInputMinutes(target, minutes);
    });
  });

  modalEl.querySelectorAll('[data-round-target]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const target = modalEl.querySelector(btn.getAttribute('data-round-target'));
      if (!target) return;
      const minutes = Number(btn.getAttribute('data-round-minutes'));
      if (!minutes || Number.isNaN(minutes)) return;
      roundInputMinutes(target, minutes);
    });
  });

  modalEl.querySelectorAll('[data-copy-from]').forEach((btn) => {
    btn.addEventListener('click', () => {
      const source = modalEl.querySelector(btn.getAttribute('data-copy-from'));
      const target = modalEl.querySelector(btn.getAttribute('data-copy-target'));
      if (!source || !target) return;
      const parsed = parseInputValue(source.value);
      if (!parsed) return;
      setInputDate(target, parsed);
    });
  });

  document.querySelectorAll('[data-shift-edit]').forEach((btn) => {
    btn.addEventListener('click', async () => {
      const detailUrl = btn.getAttribute('data-detail-url');
      const actionUrl = btn.getAttribute('data-action-url');
      form.setAttribute('action', actionUrl);
      clockInInput.value = '';
      clockOutInput.value = '';
      userLabel.textContent = '読み込み中…';
      summaryLabel.textContent = '';
      workedLabel.textContent = '--:--';
      breaksLabel.textContent = '--:--';
      breakCountLabel.textContent = '';
      ipLabel.textContent = '';
      clockInMeta.textContent = '';
      clockOutMeta.textContent = '';
      showError('');
      toggleLoading(true);
      modal.show();
      try {
        const response = await fetch(detailUrl, { headers: { 'Accept': 'application/json' } });
        if (!response.ok) {
          throw new Error('データの取得に失敗しました');
        }
        const data = await response.json();
        userLabel.textContent = `${data.user_name || data.user_username || ''}`;
        const summaryParts = [];
        if (data.user_username) summaryParts.push(`ユーザーID: ${data.user_username}`);
        if (data.user_email) summaryParts.push(`メール: ${data.user_email}`);
        if (data.worked_hms) summaryParts.push(`実働: ${data.worked_hms}`);
        summaryLabel.textContent = summaryParts.join(' ／ ');
        clockInInput.value = data.clock_in_form || '';
        clockOutInput.value = data.clock_out_form || '';
        workedLabel.textContent = data.worked_hms || '--:--';
        breaksLabel.textContent = data.break_hms || '--:--';
        breakCountLabel.textContent = data.break_count !== undefined ? `休憩回数: ${data.break_count}` : '';
        ipLabel.innerHTML = `${data.clock_in_ip || '-'}<br>${data.clock_out_ip || '-'}`;
        clockInMeta.textContent = buildMetaText(data.clock_in_at, data.clock_in_utc);
        clockOutMeta.textContent = buildMetaText(data.clock_out_at, data.clock_out_utc);
      } catch (err) {
        showError(err.message);
      } finally {
        toggleLoading(false);
      }
    });
  });
});
</script>
{% endblock %}
