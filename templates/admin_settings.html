{% extends "layout.html" %}
{% block content %}
<div class="card shadow-sm">
  <div class="card-body">
    <h2 class="h5">システム設定</h2>
    
    <div class="alert alert-info">
      <strong>設定について:</strong> これらの設定はデータベースに保存され、環境変数より優先されます。設定変更は即座に反映されます。
    </div>
    
    <form method="POST" class="mt-3">
      <input type="hidden" name="csrf_token" value="{{ session.csrf_token }}">
      
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="h6 mb-0">定期CSV自動送信設定</h3>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">送信先メールアドレス</label>
            <input type="email" class="form-control" name="csv_export_email" value="{{ csv_email }}" placeholder="admin@example.com">
            <small class="form-text text-muted">CSVファイルを送信するメールアドレス</small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">スケジュール</label>
            <select class="form-select" name="csv_export_schedule" id="csv_schedule_select">
              <option value="" {% if not csv_schedule %}selected{% endif %}>無効</option>
              <option value="daily" {% if csv_schedule == 'daily' %}selected{% endif %}>毎日（朝9時）</option>
              <option value="weekly" {% if csv_schedule == 'weekly' %}selected{% endif %}>毎週月曜日（朝9時）</option>
              <option value="monthly" {% if csv_schedule == 'monthly' %}selected{% endif %}>毎月1日（朝9時）</option>
              <option value="custom" {% if csv_schedule and csv_schedule not in ['daily', 'weekly', 'monthly', ''] %}selected{% endif %}>カスタム（cron形式）</option>
            </select>
            <small class="form-text text-muted">定期送信のスケジュール</small>
          </div>
          
          <div class="mb-3" id="cron_input_group" style="display: none;">
            <label class="form-label">Cron形式（例: 0 9 * * *）</label>
            <input type="text" class="form-control" name="csv_export_schedule_cron" id="csv_schedule_cron" 
                   value="{% if csv_schedule and csv_schedule not in ['daily', 'weekly', 'monthly', ''] %}{{ csv_schedule }}{% endif %}" 
                   placeholder="0 9 * * *">
            <small class="form-text text-muted">
              形式: 分 時 日 月 曜日<br>
              例: <code>0 9 * * *</code> (毎日9時), <code>0 9 * * 1</code> (毎週月曜9時)
            </small>
          </div>
          
          <div class="mb-3">
            <label class="form-label">エクスポート期間（日数）</label>
            <input type="number" class="form-control" name="csv_export_days" value="{{ csv_days }}" min="1" max="365">
            <small class="form-text text-muted">過去何日分のデータをエクスポートするか</small>
          </div>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header">
          <h3 class="h6 mb-0">SMTP設定（メール送信）</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">SMTPホスト</label>
              <input type="text" class="form-control" name="smtp_host" value="{{ smtp_host }}" placeholder="smtp.example.com">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">SMTPポート</label>
              <input type="number" class="form-control" name="smtp_port" value="{{ smtp_port }}" placeholder="587">
            </div>
          </div>
          
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">SMTPユーザー名</label>
              <input type="text" class="form-control" name="smtp_user" value="{{ smtp_user }}" placeholder="your-email@example.com">
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">SMTPパスワード</label>
              <input type="password" class="form-control" name="smtp_password" value="{{ smtp_password }}" placeholder="password">
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-label">送信元メールアドレス</label>
            <input type="email" class="form-control" name="smtp_from" value="{{ smtp_from }}" placeholder="noreply@example.com">
            <small class="form-text text-muted">メールの送信元として表示されるアドレス</small>
          </div>
          
          <div class="mb-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="smtp_use_tls" id="smtp_use_tls" {% if smtp_use_tls %}checked{% endif %}>
              <label class="form-check-label" for="smtp_use_tls">
                TLS/SSLを使用する
              </label>
            </div>
            <small class="form-text text-muted">ポート587など、STARTTLSを使用する場合は有効にしてください</small>
          </div>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">設定を保存</button>
        <a href="{{ url_for('admin') }}" class="btn btn-secondary">キャンセル</a>
      </div>
    </form>
    
    <div class="mt-4">
      <h3 class="h6">現在の設定状態</h3>
      <div class="alert alert-secondary">
        {% if csv_email and csv_schedule %}
        <strong>定期CSV送信:</strong> 有効<br>
        <strong>スケジュール:</strong> {{ csv_schedule }}<br>
        <strong>送信先:</strong> {{ csv_email }}<br>
        <strong>エクスポート期間:</strong> 過去{{ csv_days }}日分
        {% else %}
        <strong>定期CSV送信:</strong> 無効（送信先メールアドレスまたはスケジュールが設定されていません）
        {% endif %}
      </div>
    </div>
  </div>
</div>

<script>
(function() {
  const scheduleSelect = document.getElementById('csv_schedule_select');
  const cronGroup = document.getElementById('cron_input_group');
  const cronInput = document.getElementById('csv_schedule_cron');
  const form = document.querySelector('form');
  
  function updateCronVisibility() {
    if (scheduleSelect.value === 'custom') {
      cronGroup.style.display = 'block';
      cronInput.setAttribute('name', 'csv_export_schedule');
      cronInput.required = true;
    } else {
      cronGroup.style.display = 'none';
      cronInput.removeAttribute('name');
      cronInput.removeAttribute('required');
    }
  }
  
  scheduleSelect.addEventListener('change', updateCronVisibility);
  
  // 初期状態のチェック
  updateCronVisibility();
  
  // フォーム送信時の処理
  form.addEventListener('submit', function(e) {
    if (scheduleSelect.value === 'custom') {
      if (!cronInput.value.trim()) {
        e.preventDefault();
        alert('Cron形式を入力してください。');
        cronInput.focus();
        return false;
      }
      // cron形式の値を設定
      cronInput.setAttribute('name', 'csv_export_schedule');
    } else if (scheduleSelect.value) {
      // プリセット値を送信するためのhiddenフィールドを追加
      const hiddenInput = document.createElement('input');
      hiddenInput.type = 'hidden';
      hiddenInput.name = 'csv_export_schedule';
      hiddenInput.value = scheduleSelect.value;
      form.appendChild(hiddenInput);
    }
  });
})();
</script>
{% endblock %}

